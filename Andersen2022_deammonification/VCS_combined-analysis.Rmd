---
title: "VCS analysis of biological and physicochemical data"
date: "`r format(Sys.time(), '%d-%m-%Y')`, Aalborg, Denmark"
author: "Lisette Thomsen & Martin Andersen"
output: html_document
editor_options: 
  chunk_output_type: console
---
```{r, eval=FALSE}
devtools::install_github("zeehio/facetscales", force = TRUE)
```

Libraries
```{r message=FALSE, warning=FALSE}
library(data.table)
library(dplyr)
library(reshape2)
library(tidyverse)
library(scales)
library(gridExtra)
library(ampvis2)
library(vegan)
library(zoo)
library(patchwork)

num_cores <- parallel::detectCores(all.tests = FALSE, logical = TRUE)
setDTthreads(threads = num_cores-2)
```

### Load in data
Physicochemical data
```{r message=FALSE, warning=FALSE}
oldfiles <- fread("kemi_data/Metadata/all_data_hourly.txt", header = TRUE, sep = ",", colClasses = c("character", "factor", "factor", "numeric")) %>% mutate(timebucket = 
    as.POSIXct(paste(
      sub("(.*?)T.*", "\\1",timebucket), 
      sub(".*T(.*?)Z", "\\1", timebucket)
      ), format = "%Y-%m-%d %H"),
    datatype = "sensor"
  )
labdata <- fread("kemi_data/all_Labdata.txt", header = TRUE, sep = ",", colClasses = c("character", "factor", "factor", "numeric")) %>% mutate(timebucket = 
    as.POSIXct(paste(
      sub("(.*?)T.*", "\\1",Date), 
      sub(".*T(.*?)Z", "\\1", Date)
      ), format = "%Y-%m-%d %H"),
    datatype = "lab"
  ) %>% select(timebucket, Tank, variable, mean=value, datatype)

# Create a daily average (for PCA model and loading into metadata)
## There are some 0 values in the sensor data that should be converted to NA, but also some NA values which can be smoothed by taking the average value on both sides of the NAs
dfM_daily <- oldfiles %>% 
  group_by(Tank, variable) %>% 
  mutate(newMean = na_if(mean, 0),
         newMean2 = rollapply(c(NA, NA, newMean, NA, NA), 5, 
    function(x) if (is.na(x[3])) mean(x, na.rm = TRUE) else x[3])) %>% ungroup() %>% 
    mutate(Date = format(timebucket, format = "%Y-%m-%d")) %>% 
    group_by(Date, Tank, variable) %>% 
    summarise(dailyMean = mean(newMean2)) %>% 
  ungroup()

df_wide <- dcast(dfM_daily, Tank+Date~variable, value.var = "dailyMean") %>% mutate(Date = as.Date(Date), Tank = paste0("0", Tank)) %>% drop_na()
```

Amplicon data
```{r message=FALSE, warning=FALSE}
otuFiles <- list.files(path = "data/", pattern = "otutable_midas37.txt")
newestFile <- tail(otuFiles, 1)

otutable <- fread(paste0("data/", newestFile), header = TRUE, sep = "\t")
metadata <- readxl::read_excel("metadata_VCS.xlsx", col_names = TRUE, sheet = "metadata") %>% as.data.frame() %>% subset(Primer == "bV4-A" & Platform == "Nanopore" & type == "sample" & !(runID %in% c("juneB1", "julyB1")) & !(samplingSpot %in% c("hydrocyclone", "overflow"))) %>% mutate(Date = as.Date(Date, origin = "1899-12-30")) %>% drop_na(SeqID)# Remove the runs where we had primer issues

metadata_extra <- left_join(metadata, df_wide, by = c("Date", "Tank"))

d_amp <- amp_load(otutable, metadata_extra)
d_amp_s <- amp_subset_samples(d_amp, !(SampleNo %in% c("PC", "NC", "EXT NEG", "192", "100") & !(ExtractionID %in% c("PC", "NC"))))

# Create new date column with month-date
d_amp_s$metadata$prettydate <- strftime(d_amp_s$metadata$Date, format = "%b-%d")
start_sampling_date <- min(d_amp_s$metadata$Date)
d_amp_s$metadata$delta_hours <- difftime(d_amp_s$metadata$Date, start_sampling_date, units = "hours")
d_amp_s$metadata$delta_days <- difftime(d_amp_s$metadata$Date, start_sampling_date, units = "days")

set.seed(42) # For reproducibility
```


### Data processing
Process physicochenmial data more - smooth NAs and make moving averages
```{r message=FALSE, warning=FALSE}
library(zoo)

# It seems there is an issue with sensor SS being 1000x lower than lab SS, depsite both units reported as mg/L. Sensor unit must be g/L and should be multiplied by 1000? Is indeed kg/m3=g/L->multiply by 1000 to get mg/L.
oldfiles_fixss <- oldfiles %>% mutate(mean = case_when(variable == "SS" & datatype == "sensor" ~ mean*1000,
                                                       TRUE ~ mean)) %>% subset(mean > 0)
#tmp <- plyr::ddply(oldfiles_fixss, .(timebucket, variable), transform, newid = paste(timebucket, seq_along(variable)))
all_sensor_fix <- oldfiles_fixss %>% dcast(., timebucket+Tank~variable, value.var = "mean", fun.aggregate = mean) %>% 
  mutate(NH4_remove = NH4_in-NH4_out,
         HRT= 320/Centrate_in,
         NH4_conc_in = NH4_in/Centrate_in*1000,
         NLR = ((NH4_conc_in/1000)/HRT)*24, # Nitrogen loading rate -first mg-N/L/h - divide by 1000 for kg-N/m3 and multiply by 24 for kg-N/m3/d
         #NO3_NH4_percent = case_when(NO3 > 0.01 ~ NO3/NH4_out, TRUE ~ NaN),
         N_converted = case_when(timebucket < "2020-10-11" ~ NH4_conc_in-rowSums(.[,c("NH4","NO2","NO3")], na.rm=TRUE),
                                 timebucket >= "2020-10-11" ~ NH4_conc_in-rowSums(.[,c("NH4","NO2","NO3", "N2O")], na.rm=TRUE)), # mg/L
         NRR = ((N_converted/1000)/HRT)*24, # Nitrogen removal rate - kg-N/m3/d
         #AOR = ((NH4_remove-(N_converted/1000/1.972))/HRT)*24, # Ammonia oxidation rate - kg-N/m3/d - seems incorrect!
         AOR = (NH4_remove-((N_converted/1000)/1.972))/HRT,
         NOR = (((NO3-(0.161*N_converted/1.972))/1000)/HRT)*24, # Nitrite oxidation rate - kg-N/m3/d
         NRE = (N_converted/1000)/NH4_in, # Nitrogen removal efficiency - %
         NH4_efficiency = ((NH4_in-NH4_out)/NH4_in)*100) %>% 
         #NH4_conc_in - rowSums(.[,c("NH4","NO2","NO3","N2O")], na.rm=TRUE)) %>% 
  melt(., id.vars = c("timebucket", "Tank"), value.name = "mean") %>% mutate(datatype = "sensor")

# First create NA values where there are 0s now. Then smooth over NA values - up to 4 in a row by taking average of previous 2 and forward 2 values. Then calculate moving averages based on these values
df_all_smooth <- all_sensor_fix %>% 
  group_by(Tank, variable) %>% 
  mutate(delta_hours = difftime(timebucket, start_sampling_date, units = "hours"),
         newMean = na_if(mean, 0),
         newMean = rollapply(c(NA, NA, mean, NA, NA), 5, 
    function(x) if (is.na(x[3])) mean(x, na.rm = TRUE) else x[3]),
        mean_07d = rollmean(newMean, k = 7*24, fill = NA),
        mean_05d = rollmean(newMean, k = 5*24, fill = NA),
        mean_03d = rollmean(newMean, k = 3*24, fill = NA)) %>% 
  ungroup()

# Merge with the lab data
labdata_p <- labdata %>% 
  mutate(delta_hours = difftime(timebucket, start_sampling_date, units = "hours"),
         newMean = mean,
         mean_07d = NA,
         mean_05d = NA,
         mean_03d = NA)

all_data_smooth <- rbind(df_all_smooth, labdata_p)

units <- c("O2" = "mg/l", "SS" = "mg/l", "NH4" = "mg/l", "NO2" = "mg/l", "NO3" = "mg/l", "pH" = NA, "Temp" = "°C", "AirFlow" = "m3/h", "NH4_in" = "kg/h", "NH4_out" = "kg/h", "NH4_remove" = "kg/h", "NH4_conc_in" = "mg/l", "N_converted" = "mg/l", "N2O" = "mg/l")
```

Calculate amount of biomass on sides - assuming 5.5m of tank covered (BL1 sensor) and 9m diameter, 1cm thick layer. Also assuming 5 g biomass per liter liquid
```{r}
bio_thickness = 1 # biomass thickness in cm
biomass_liter = 5 # biomass per liter (g/L)

# Surface of cylinder: 2π*r*h + π*r² - since we assume the top of the cylinder is not covered or in contact with liquid - assuming that the biomass layer is very dense (50g biomass/L) and Brocadia in 25% abundance
surface_bio <- (2*pi*4.5*5.5 + pi*(4.5^2))*100*(bio_thickness/10)*50*0.25 # dm3 biomass = L

# Volume of cylinder: π*r²*h
volume_bio <- pi*(4.5^2)*5.5*1000*biomass_liter*0.25 # dm3 volume = L - assuming 25% Brocadia

(surface_bio/volume_bio)*100
```


# Plots

### Biological


Heatmaps of all periods, tank 1
```{r, fig.height = 10, fig.width = 15, fig.align='center', echo=T, message=FALSE, warning=FALSE}
#baseline_tank1 <- amp_subset_samples(d_amp_s, Tank == "01" & Date > "2020-05-01" & Date < "2020-06-28")
tank1_all_phases <- amp_subset_samples(d_amp_s, Tank == "01")
tank1_phase1 <- amp_subset_samples(tank1_all_phases, Date < "2020-07-01")
tank1_phase2 <- amp_subset_samples(tank1_all_phases, Date >= "2020-07-01" & Date < "2020-11-01")
tank1_phase3 <- amp_subset_samples(tank1_all_phases, Date >= "2020-11-01")

# Phase I - baseline
tank1_phase1_heatmap <- amp_heatmap(tank1_phase1,
            group_by = c("delta_days"),
            #facet_by = "Tank",
            tax_aggregate = "Genus",
            tax_add = "Phylum",
            plot_colorscale = "sqrt",
            min_abundance = 0.1,
            tax_show = 30,
            color_vector = c("white", "red3"),
            plot_values_size = 3, textmap=F,
            plot_values = T,
            #plot_legendbreaks = c(1, 5, 10, 20),
            plot_functions = T,
            functions = c("AOB", "NOB"), 
            rel_widths = c(0.87, 0.13)) 
tank1_phase1_heatmap$heatmap <- tank1_phase1_heatmap$heatmap + theme(axis.text = element_text(size = 8),
        axis.text.x = element_text(angle = 0, hjust = 0.5, vjust = 1),
        legend.position = "bottom")
tank1_phase1_heatmap
ggsave(filename = paste0("figures/",format(Sys.Date(), "%Y-%m-%d"),"_heatmap-phase1-tank1.png"), width = 14, height = 10, dpi = 600)

# Phase II - High DO
tank1_phase2_heatmap <- amp_heatmap(tank1_phase2,
            group_by = c("delta_days"),
            #facet_by = "Tank",
            tax_aggregate = "Genus",
            tax_add = "Phylum",
            plot_colorscale = "sqrt",
            min_abundance = 0.1,
            tax_show = 30,
            color_vector = c("white", "red3"),
            plot_values_size = 3, textmap=F,
            plot_values = F,
            #plot_legendbreaks = c(1, 5, 10, 20),
            plot_functions = T,
            functions = c("AOB", "NOB"), 
            rel_widths = c(0.9, 0.10)) 
tank1_phase2_heatmap$heatmap <- tank1_phase2_heatmap$heatmap + theme(axis.text = element_text(size = 8),
        axis.text.x = element_text(angle = 0, hjust = 0.5, vjust = 1),
        legend.position = "bottom")
tank1_phase2_heatmap
ggsave(filename = paste0("figures/",format(Sys.Date(), "%Y-%m-%d"),"_heatmap-phase2-tank1.png"), width = 14, height = 10, dpi = 600)

# Phase III - Return to normal DO
tank1_phase3_heatmap <- amp_heatmap(tank1_phase3,
            group_by = c("delta_days"),
            #facet_by = "Tank",
            tax_aggregate = "Genus",
            tax_add = "Phylum",
            plot_colorscale = "sqrt",
            min_abundance = 0.1,
            tax_show = 30,
            color_vector = c("white", "red3"),
            plot_values_size = 3, textmap=F,
            plot_values = F,
            #plot_legendbreaks = c(1, 5, 10, 20),
            plot_functions = T,
            functions = c("AOB", "NOB"), 
            rel_widths = c(0.9, 0.10)) 
tank1_phase3_heatmap$heatmap <- tank1_phase3_heatmap$heatmap + theme(axis.text = element_text(size = 8),
        axis.text.x = element_text(angle = 0, hjust = 0.5, vjust = 1),
        legend.position = "bottom")
tank1_phase3_heatmap
ggsave(filename = paste0("figures/",format(Sys.Date(), "%Y-%m-%d"),"_heatmap-phase3-tank1.png"), width = 14, height = 10, dpi = 600)


```

Phase I reactor 1, every 7 days
```{r, fig.height = 10, fig.width = 15, fig.align='center', echo=T, message=FALSE, warning=FALSE}
select_days <- c(0, 8, 15, 23, 30, 37, 44, 51, 57)
tank1_phase1_selectdays <- amp_subset_samples(tank1_phase1, delta_days %in% select_days)

tank1_phase1_heatmap_select <- amp_heatmap(tank1_phase1_selectdays,
            group_by = c("delta_days"),
            #facet_by = "Tank",
            tax_aggregate = "Genus",
            tax_add = "Phylum",
            plot_colorscale = "sqrt",
            min_abundance = 0.1,
            tax_show = 20,
            #color_vector = c("white", "red"),
            plot_values_size = 3, textmap=F,
            plot_values = T,
            #plot_legendbreaks = c(1, 5, 10, 20),
            plot_functions = T,
            functions = c("AOB", "NOB", "Anammox", "Methanogen", "Nitrite reduction", "Fermentation"), 
            rel_widths = c(0.75, 0.25)) 
tank1_phase1_heatmap_select$heatmap <- tank1_phase1_heatmap_select$heatmap + theme(axis.text = element_text(size = 8),
        axis.text.x = element_text(angle = 0, hjust = 0.5, vjust = 1),
        legend.position = "none")
tank1_phase1_heatmap_select

#ggsave(filename = paste0("figures/",format(Sys.Date(), "%Y-%m-%d"),"_heatmap-phase1-tank1_select.png"), width = 8, height = 10, dpi = 300)
```

Which species do we see in the key genera?
```{r, fig.height = 10, fig.width = 15, fig.align='center', echo=T, message=FALSE, warning=FALSE}
key_genera_vector <- c("Ca_Brocadia", "OLB8", "midas_g_731", "Nitrosomonas", "Nitrospira", "Methanomethylovorans")
baseline_key_genera <- amp_subset_taxa(tank1_phase1, tax_vector = key_genera_vector)

amp_heatmap(baseline_key_genera,
            group_by = c("delta_days"),
            tax_aggregate = "Species",
            tax_add = "Genus",
            plot_colorscale = "sqrt",
            #min_abundance = 0.1,
            tax_show = 20,
            color_vector = c("white", "red3"),
            plot_values_size = 3,
            plot_values = T)
```


Heatmaps of all periods, tank 2
```{r, fig.height = 10, fig.width = 15, fig.align='center', echo=T, message=FALSE, warning=FALSE}
#baseline_tank1 <- amp_subset_samples(d_amp_s, Tank == "01" & Date > "2020-05-01" & Date < "2020-06-28")
tank2_all_phases <- amp_subset_samples(d_amp_s, Tank == "02" & !(samplingSpot %in% c("overflow", "hydrocyclone")))
tank2_phase1 <- amp_subset_samples(tank2_all_phases, Date < "2020-07-01")
tank2_phase2 <- amp_subset_samples(tank2_all_phases, Date >= "2020-07-01" & Date < "2020-11-01")
tank2_phase3 <- amp_subset_samples(tank2_all_phases, Date >= "2020-11-01")

tank2_phase1_selectdays <- amp_subset_samples(tank2_phase1, delta_days %in% select_days)

# Phase I - baseline
tank2_phase1_heatmap <- amp_heatmap(tank2_phase1_selectdays,
            group_by = c("delta_days"),
            #facet_by = "Tank",
            tax_aggregate = "Genus",
            tax_add = "Phylum",
            plot_colorscale = "sqrt",
            min_abundance = 0.1,
            tax_show = 30,
            #color_vector = c("white", "red"),
            plot_values_size = 3, textmap=F,
            plot_values = T,
            #plot_legendbreaks = c(1, 5, 10, 20),
            plot_functions = T,
            functions = c("AOB", "NOB", "Anammox", "Methanogen", "Nitrite reduction", "Fermentation"), 
            rel_widths = c(0.75, 0.25))
            #functions = c("AOB", "NOB"), 
            #rel_widths = c(0.87, 0.13)) 
tank2_phase1_heatmap$heatmap <- tank2_phase1_heatmap$heatmap + theme(axis.text = element_text(size = 8),
        axis.text.x = element_text(angle = 0, hjust = 0.5, vjust = 1),
        legend.position = "none")
tank2_phase1_heatmap
ggsave(filename = paste0("figures/",format(Sys.Date(), "%Y-%m-%d"),"_heatmap-phase1-tank2_select.png"), width = 8, height = 10, dpi = 300)
# ggsave(filename = paste0("figures/",format(Sys.Date(), "%Y-%m-%d"),"_heatmap-phase1-tank2.png"), width = 14, height = 10, dpi = 600)

# Phase II - High DO
tank2_phase2_heatmap <- amp_heatmap(tank2_phase2,
            group_by = c("delta_days"),
            #facet_by = "Tank",
            tax_aggregate = "Genus",
            tax_add = "Phylum",
            plot_colorscale = "sqrt",
            min_abundance = 0.1,
            tax_show = 30,
            color_vector = c("white", "red3"),
            plot_values_size = 3, textmap=F,
            plot_values = F,
            #plot_legendbreaks = c(1, 5, 10, 20),
            plot_functions = T,
            functions = c("AOB", "NOB"), 
            rel_widths = c(0.9, 0.10)) 
tank2_phase2_heatmap$heatmap <- tank2_phase2_heatmap$heatmap + theme(axis.text = element_text(size = 8),
        axis.text.x = element_text(angle = 0, hjust = 0.5, vjust = 1),
        legend.position = "bottom")
tank2_phase2_heatmap
# ggsave(filename = paste0("figures/",format(Sys.Date(), "%Y-%m-%d"),"_heatmap-phase2-tank2.png"), width = 14, height = 10, dpi = 600)

# Phase III - Return to normal DO
tank2_phase3_heatmap <- amp_heatmap(tank2_phase3,
            group_by = c("delta_days"),
            #facet_by = "Tank",
            tax_aggregate = "Genus",
            tax_add = "Phylum",
            plot_colorscale = "sqrt",
            min_abundance = 0.1,
            tax_show = 30,
            color_vector = c("white", "red3"),
            plot_values_size = 3, textmap=F,
            plot_values = F,
            #plot_legendbreaks = c(1, 5, 10, 20),
            plot_functions = T,
            functions = c("AOB", "NOB"), 
            rel_widths = c(0.9, 0.10)) 
tank2_phase3_heatmap$heatmap <- tank2_phase3_heatmap$heatmap + theme(axis.text = element_text(size = 8),
        axis.text.x = element_text(angle = 0, hjust = 0.5, vjust = 1),
        legend.position = "bottom")
tank2_phase3_heatmap
# ggsave(filename = paste0("figures/",format(Sys.Date(), "%Y-%m-%d"),"_heatmap-phase3-tank2.png"), width = 14, height = 10, dpi = 600)
```


##### NOB/AOB development and ratios
Tank 1
```{r, fig.height = 10, fig.width = 15, fig.align='center', echo=T, message=FALSE, warning=FALSE}
# Create nitrifier timeseries
nitri_taxa <- c("Nitrospira", "Ca_Brocadia", "Nitrosomonas")

tank1_nitrifiers <- amp_subset_taxa(tank1_all_phases, nitri_taxa, normalise = TRUE) %>% amp_export_long(., tax_levels = c("Phylum", "Genus")) %>% mutate(Display = paste0(Phylum, "; ", Genus)) %>%  group_by(SeqID, Date, delta_days, Display) %>% summarise(Abundance = sum(count), .groups = 'drop') %>% mutate(week = lubridate::week(Date)) %>% group_by(Display) %>% mutate(mean_07d = rollmean(Abundance, k = 5, fill = NA), mean_14d = rollmean(Abundance, k = 10, fill = NA))


# Timelines
plot_nitrifiers_tank1 <- ggplot(tank1_nitrifiers, aes(x=delta_days, y=Abundance, color = Display)) + geom_point() + geom_line(aes(x=delta_days, y=mean_14d, color = Display)) + scale_y_continuous(breaks = seq(0, 24, 2)) + scale_x_continuous(breaks = seq(0, 365, 25), limits=c(0,365)) + theme_bw() + 
  theme(panel.grid.minor = element_blank(),
        panel.background = element_blank(), 
        legend.title = element_blank(),
        panel.border = element_blank(),
        axis.line = element_line(colour = "black"),
        legend.key.size = unit(0.05, "cm"),
        legend.position = c(0.89, 0.74),
        legend.margin=margin(t = 0.1, unit='cm'))  + scale_color_discrete(limits=c("Planctomycetes; Ca_Brocadia", "Proteobacteria; Nitrosomonas", "Nitrospirae; Nitrospira")) + ylab("Read abundance (%)") + xlab("Day") + 
  annotate("rect", xmin = 0, ymin=0, xmax=58, ymax=Inf, alpha=0.1) +
  annotate("text", x = 58/2, y = 25, label = "Phase I") +
  annotate("rect", xmin = 58, ymin=0, xmax=58+31, ymax=Inf, alpha=0.1, fill = "blue") +
  annotate("text", x = 58+15, y = 25, label = "Phase IIa") + 
  annotate("rect", xmin = 89, ymin=0, xmax=181, ymax=Inf, alpha=0.1, fill = "skyblue") +
  annotate("text", x = (181-89)/2+89, y = 25, label = "Phase IIb") + 
  annotate("rect", xmin = 181, ymin=0, xmax=Inf, ymax=Inf, alpha=0.1, fill = "red") +
  annotate("text", x = (365-181)/2+181, y = 25, label = "Phase III")# + ggtitle("Nitrifiers in reactor 1, relative read abundance and 14 day moving average")


## Ratios
# Subset to the only known AOB (Nitrosomonas) and NOB (Nitrospira) in the tanks, and then only look at tank 01
nitrifiers_ratio_tank1 <- amp_subset_taxa(d_amp_s, tax_vector = c("Nitrosomonas", "Nitrospira")) %>% amp_subset_samples(Tank == "01" & !(samplingSpot %in% c("overflow", "hydrocyclone")))

taxcount <- levels(as.factor(nitrifiers_ratio_tank1$tax$OTU)) %>% length()

# Create an ampvis2 boxplot and output the details to manipulate boxplot
box_nitri <- amp_boxplot(nitrifiers_ratio_tank1,
            #tax_aggregate = "OTU",
            tax_aggregate = "Genus",
            tax_show = taxcount,
            detailed_output = TRUE,normalise = F)

# Save the data from the detailed output in a new variable - outputs 9 replicate rows for each sample for some reason
box_nitri <- box_nitri$plot$data %>% 
  .[!duplicated(.), ]

nitri_ratio <- dcast(box_nitri, Sample~Display, value.var = "Abundance") %>% 
  mutate(aob_nob_ratio = Nitrosomonas/Nitrospira,
         nob_aob_ratio = Nitrospira/Nitrosomonas,
        #mean_14d_aob_nob = rollmean(aob_nob_ratio, k = 14, fill = NA),
        mean_14d_nob_aob = rollmean(nob_aob_ratio, k = 10, fill = NA))
nitri_ratio2 <- inner_join(nitri_ratio, nitrifiers_ratio_tank1$metadata, by = c("Sample" = "SeqID"))
nitri_ratio3 <- nitri_ratio2 %>% mutate(diff_mean = mean_14d_nob_aob - lag(mean_14d_nob_aob), diff_ratio = nob_aob_ratio-lag(nob_aob_ratio))


nob_aob <- ggplot(nitri_ratio2, aes(x = delta_days, y = nob_aob_ratio)) + geom_point() +  
  geom_line(aes(x=delta_days, y = mean_14d_nob_aob), color = "red") + 
  theme_bw() + xlab("Day") + ylab("NOB/AOB ratio") + scale_y_continuous(breaks = seq(0.0, 0.7, 0.1), limits=c(0.0,0.7)) + scale_x_continuous(breaks = seq(0, 365, 25), limits=c(0,365)) + theme(panel.grid.minor = element_blank(),
        panel.background = element_blank(), 
        legend.title = element_blank(),
        panel.border = element_blank(),
        axis.line = element_line(colour = "black")) +
  annotate("rect", xmin = 0, ymin=0, xmax=58, ymax=Inf, alpha=0.1) +
  annotate("text", x = 58/2, y = 0.7, label = "Phase I") +
  annotate("rect", xmin = 58, ymin=0, xmax=58+31, ymax=Inf, alpha=0.1, fill = "blue") +
  annotate("text", x = 58+15, y = 0.7, label = "Phase IIa") + 
  annotate("rect", xmin = 89, ymin=0, xmax=181, ymax=Inf, alpha=0.1, fill = "skyblue") +
  annotate("text", x = (181-89)/2+89, y = 0.7, label = "Phase IIb") + 
  annotate("rect", xmin = 181, ymin=0, xmax=Inf, ymax=Inf, alpha=0.1, fill = "red") +
  annotate("text", x = (365-181)/2+181, y = 0.7, label = "Phase III")# + ggtitle("NOB/AOB Ratio + 14d moving average")

nob_aob_meanvelocity <- ggplot(nitri_ratio3, aes(x = delta_days, y = diff_mean)) + geom_bar(stat = "identity") + xlab("Day") + ylab("Daily ratio change") + theme_bw() + scale_x_continuous(breaks = seq(0, 365, 25), limits=c(0,365)) + scale_y_continuous(breaks = seq(-0.06, 0.06, 0.01), limits = c(-0.06,0.06)) + theme(panel.grid.minor = element_blank(),
        panel.background = element_blank(), 
        legend.title = element_blank(),
        panel.border = element_blank(),
        axis.line = element_line(colour = "black")) +
  annotate("rect", xmin = 0, ymin=-0.06, xmax=58, ymax=Inf, alpha=0.1) +
  annotate("text", x = 58/2, y = 0.06, label = "Phase I") +
  annotate("rect", xmin = 58, ymin=-0.06, xmax=58+31, ymax=Inf, alpha=0.1, fill = "blue") +
  annotate("text", x = 58+15, y = 0.06, label = "Phase IIa") + 
  annotate("rect", xmin = 89, ymin=-0.06, xmax=181, ymax=Inf, alpha=0.1, fill = "skyblue") +
  annotate("text", x = (181-89)/2+89, y = 0.06, label = "Phase IIb") + 
  annotate("rect", xmin = 181, ymin=-0.06, xmax=Inf, ymax=Inf, alpha=0.1, fill = "red") +
  annotate("text", x = (365-181)/2+181, y = 0.06, label = "Phase III")# + ggtitle("14 day moving average daily ratio change")
#nob_aob_ratiovelocity <- ggplot(nitri_ratio3, aes(x = as.Date(Date), y = diff_ratio)) + geom_bar(stat = "identity") + xlab("Date") + ylab("NOB/AOB ratio change (velocity)") + theme_bw() +scale_x_date(breaks = "month", limits = as.Date(c("2020-05-01", "2020-12-31"))) + ggtitle("Daily ratio change")

# nob_aob_plots <- cowplot::plot_grid(plot_nitrifiers_tank1, nob_aob, nob_aob_meanvelocity, labels = c('A', 'B', 'C'), ncol = 1, align = "v")


# ggsave(filename = paste0("figures/",format(Sys.Date(), "%Y-%m-%d"),"_nob_aob-fullperiod-tank1.png"), plot = nob_aob_plots, width = 12, height = 10, dpi = 600)
```

Tank 2 - NEW
```{r, fig.height = 10, fig.width = 15, fig.align='center', echo=T, message=FALSE, warning=FALSE}
# Create nitrifier timeseries
nitri_taxa <- c("Nitrospira", "Ca_Brocadia", "Nitrosomonas")

tank2_nitrifiers <- amp_subset_taxa(tank2_all_phases, nitri_taxa, normalise = TRUE) %>% amp_export_long(., tax_levels = c("Phylum", "Genus")) %>% mutate(Display = paste0(Phylum, "; ", Genus)) %>%  group_by(SeqID, Date, delta_days, Display) %>% summarise(Abundance = sum(count), .groups = 'drop') %>% mutate(week = lubridate::week(Date)) %>% group_by(Display) %>% mutate(mean_07d = rollmean(Abundance, k = 5, fill = NA), mean_14d = rollmean(Abundance, k = 10, fill = NA))


# Timelines
plot_nitrifiers_tank2 <- ggplot(tank2_nitrifiers, aes(x=delta_days, y=Abundance, color = Display)) + geom_point() + geom_line(aes(x=delta_days, y=mean_14d, color = Display)) + scale_y_continuous(breaks = seq(0, 24, 2)) + scale_x_continuous(breaks = seq(0, 220, 10), limits=c(0,224)) + theme_bw() + 
  theme(panel.grid.minor = element_blank(),
        panel.background = element_blank(), 
        legend.title = element_blank(),
        panel.border = element_blank(),
        axis.line = element_line(colour = "black"),
        legend.key.size = unit(0.05, "cm"),
        legend.position = c(0.89, 0.74),
        legend.margin=margin(t = 0.1, unit='cm')) + scale_color_discrete(limits=c("Planctomycetes; Ca_Brocadia", "Proteobacteria; Nitrosomonas", "Nitrospirae; Nitrospira")) + ylab("Read abundance (%)") + xlab("Day") + 
  annotate("rect", xmin = 0, ymin=0, xmax=58, ymax=Inf, alpha=0.1) +
  annotate("text", x = 58/2, y = 25, label = "Phase I") +
  annotate("rect", xmin = 58, ymin=0, xmax=58+31, ymax=Inf, alpha=0.1, fill = "blue") +
  annotate("text", x = 58+15, y = 25, label = "Phase IIa") + 
  annotate("rect", xmin = 89, ymin=0, xmax=181, ymax=Inf, alpha=0.1, fill = "skyblue") +
  annotate("text", x = (181-89)/2+89, y = 25, label = "Phase IIb") + 
  annotate("rect", xmin = 181, ymin=0, xmax=Inf, ymax=Inf, alpha=0.1, fill = "red") +
  annotate("text", x = (224-181)/2+181, y = 25, label = "Phase III")# + ggtitle("Nitrifiers in reactor 2, relative read abundance and 14 day moving average")


## Ratios
# Subset to the only known AOB (Nitrosomonas) and NOB (Nitrospira) in the tanks, and then only look at tank 01
nitrifiers_ratio_tank2 <- amp_subset_taxa(d_amp_s, tax_vector = c("Nitrosomonas", "Nitrospira")) %>% amp_subset_samples(Tank == "02" & !(samplingSpot %in% c("overflow", "hydrocyclone")))

taxcount_t2 <- levels(as.factor(nitrifiers_ratio_tank2$tax$OTU)) %>% length()

# Create an ampvis2 boxplot and output the details to manipulate boxplot
box_nitri_t2 <- amp_boxplot(nitrifiers_ratio_tank2,
            #tax_aggregate = "OTU",
            tax_aggregate = "Genus",
            tax_show = taxcount_t2,
            detailed_output = TRUE,normalise = F)

# Save the data from the detailed output in a new variable - outputs 9 replicate rows for each sample for some reason
box_nitri_t2 <- box_nitri_t2$plot$data %>% 
  .[!duplicated(.), ]

nitri_ratio_t2 <- dcast(box_nitri_t2, Sample~Display, value.var = "Abundance") %>% 
  mutate(aob_nob_ratio = Nitrosomonas/Nitrospira,
         nob_aob_ratio = Nitrospira/Nitrosomonas,
        #mean_14d_aob_nob = rollmean(aob_nob_ratio, k = 14, fill = NA),
        mean_14d_nob_aob = rollmean(nob_aob_ratio, k = 10, fill = NA))
nitri_ratio2_t2 <- inner_join(nitri_ratio_t2, nitrifiers_ratio_tank2$metadata, by = c("Sample" = "SeqID"))
nitri_ratio3_t2 <- nitri_ratio2_t2 %>% mutate(diff_mean = mean_14d_nob_aob - lag(mean_14d_nob_aob), diff_ratio = nob_aob_ratio-lag(nob_aob_ratio))


nob_aob_t2 <- ggplot(nitri_ratio2_t2, aes(x = delta_days, y = nob_aob_ratio)) + geom_point() +  
  geom_line(aes(x=delta_days, y = mean_14d_nob_aob), color = "red") + 
  theme_bw() + xlab("Day") + ylab("NOB/AOB ratio") + scale_y_continuous(breaks = seq(0.0, 0.7, 0.1), limits=c(0.0,0.7)) + scale_x_continuous(breaks = seq(0, 220, 10), limits=c(0,224)) + theme(panel.grid.minor = element_blank(),
        panel.background = element_blank(), 
        legend.title = element_blank(),
        panel.border = element_blank(),
        axis.line = element_line(colour = "black")) +
  annotate("rect", xmin = 0, ymin=0, xmax=58, ymax=Inf, alpha=0.1) +
  annotate("text", x = 58/2, y = 0.7, label = "Phase I") +
  annotate("rect", xmin = 58, ymin=0, xmax=58+31, ymax=Inf, alpha=0.1, fill = "blue") +
  annotate("text", x = 58+15, y = 0.7, label = "Phase IIa") + 
  annotate("rect", xmin = 89, ymin=0, xmax=181, ymax=Inf, alpha=0.1, fill = "skyblue") +
  annotate("text", x = (181-89)/2+89, y = 0.7, label = "Phase IIb") + 
  annotate("rect", xmin = 181, ymin=0, xmax=Inf, ymax=Inf, alpha=0.1, fill = "red") +
  annotate("text", x = (224-181)/2+181, y = 0.7, label = "Phase III")# + ggtitle("NOB/AOB Ratio + 14d moving average")

nob_aob_meanvelocity_t2 <- ggplot(nitri_ratio3_t2, aes(x = delta_days, y = diff_mean)) + geom_bar(stat = "identity") + xlab("Day") + ylab("Daily ratio change") + theme_bw()  + scale_x_continuous(breaks = seq(0, 220, 10), limits=c(0,224)) + scale_y_continuous(breaks = seq(-0.06, 0.06, 0.01), limits = c(-0.06,0.06)) + theme(panel.grid.minor = element_blank(),
        panel.background = element_blank(), 
        legend.title = element_blank(),
        panel.border = element_blank(),
        axis.line = element_line(colour = "black")) +
  annotate("rect", xmin = 0, ymin=-0.06, xmax=58, ymax=Inf, alpha=0.1) +
  annotate("text", x = 58/2, y = 0.06, label = "Phase I") +
  annotate("rect", xmin = 58, ymin=-0.06, xmax=58+31, ymax=Inf, alpha=0.1, fill = "blue") +
  annotate("text", x = 58+15, y = 0.06, label = "Phase IIa") + 
  annotate("rect", xmin = 89, ymin=-0.06, xmax=181, ymax=Inf, alpha=0.1, fill = "skyblue") +
  annotate("text", x = (181-89)/2+89, y = 0.06, label = "Phase IIb") + 
  annotate("rect", xmin = 181, ymin=-0.06, xmax=Inf, ymax=Inf, alpha=0.1, fill = "red") +
  annotate("text", x = (224-181)/2+181, y = 0.06, label = "Phase III")# + ggtitle("14 day moving average daily ratio change")
#nob_aob_ratiovelocity <- ggplot(nitri_ratio3, aes(x = as.Date(Date), y = diff_ratio)) + geom_bar(stat = "identity") + xlab("Date") + ylab("NOB/AOB ratio change (velocity)") + theme_bw() +scale_x_date(breaks = "month", limits = as.Date(c("2020-05-01", "2020-12-31"))) + ggtitle("Daily ratio change")

#nob_aob_plots_t2 <- cowplot::plot_grid(plot_nitrifiers_tank2, nob_aob_t2, nob_aob_meanvelocity_t2, labels = c('A', 'B', 'C'), ncol = 1, align = "v")


#ggsave(filename = paste0("figures/",format(Sys.Date(), "%Y-%m-%d"),"_nob_aob-fullperiod-tank2.png"), plot = nob_aob_plots_t2, width = 12, height = 10, dpi = 600)
```



##### PCA trajectory
```{r fig.height = 10, fig.width = 15, fig.align='center', echo=T, message=FALSE, warning=FALSE}
d_amp_s$metadata$Week <- strftime(d_amp_s$metadata$Date, format = "%V")
d_amp_s$metadata$Month <- strftime(d_amp_s$metadata$Date, format = "%m")
d_amp_s$metadata$integer_date <- as.integer(d_amp_s$metadata$Date)
#labels <- pretty(d_amp_s$metadata$integer_date, 3)
labels <- as.numeric(d_amp_s$metadata$delta_days)
d_amp_s$metadata$delta_days <- as.numeric(d_amp_s$metadata$delta_days)

months <- strftime(d_amp_s$metadata$Date, format = "%m")
months2 <- pretty(d_amp_s$metadata$Date)

myBreaks <- function(x){
    breaks <- c(min(as.numeric(x)),median(as.numeric(x)),max(as.numeric(x)))
    #attr(breaks,"labels") <- as.Date(breaks, origin="1970-01-01")
    attr(breaks,"labels") <- as.numeric(delta_days)
    names(breaks) <- attr(breaks,"labels")
    return(breaks)
}
d_amp_s$metadata$Reactor <- d_amp_s$metadata$Tank
p1 <- amp_ordinate(data = d_amp_s, 
             type = "PCA", 
             transform = "hellinger", 
             #sample_label_by = "Month",
             sample_color_by = "delta_days",
             sample_shape_by = "Reactor",
             sample_trajectory = "delta_days",
             sample_trajectory_group = "Tank",
             sample_label_segment_color = "grey50",
             #species_shape = 0,
             #sample_colorframe = TRUE,
             sample_label_size = 2) +
  theme_classic() +
  theme(legend.position = "bottom") #+
p2 <- p1 + scale_color_gradient2(low = "yellow", mid = "darkblue", high = "red", guide="colourbar", midpoint = mean(d_amp_s$metadata$delta_days)) +
  scale_shape_manual(values=c(13, 19)) + #labs(color="Date") +
    guides(color = guide_colourbar(label.theme = element_text(angle = 0, hjust = 0, size = 10), title = NULL)) + scale_x_continuous(breaks = seq(-0.25, 0.25, 0.05)) + scale_y_continuous(breaks = seq(-0.50, 0.40, 0.05))
ggsave(filename = paste0("figures/",format(Sys.Date(), "%Y-%m-%d"),"_PCA-fullperiod-bothtanks.png"), plot = p2, width = 10, height = 10, dpi = 300)
```


##### Community timelines
Nitrifiers in all three phases
```{r, fig.height = 10, fig.width = 15, fig.align='center', echo=T, message=FALSE, warning=FALSE}
#taxcount_midas <- levels(as.factor(MiDAS$tax$Genus)) %>% length()
nitri_taxa <- c("Nitrospira", "Ca_Brocadia", "Nitrosomonas")

nitrifiers <- amp_subset_taxa(d_amp_s, tax_vector = nitri_taxa, normalise = TRUE)

lines_text <- data.frame(vlines = c("2020-07-01", "2020-11-01"), labels = c("Phase II start", "Phase III start"), stringsAsFactors = FALSE)

# Tank 1
tank1 <- amp_subset_samples(nitrifiers, Tank == "01")
p1n <- amp_timeseries(tank1, time_variable = "Date", tax_aggregate = "Genus", tax_add = "Phylum", normalise = FALSE)
p2n <- p1n + geom_vline(data = lines_text, aes(xintercept = as.Date(vlines)), linetype = "dashed", alpha = 0.5) + geom_text(data = lines_text, aes(x = as.Date(vlines), y = 22, label = labels), inherit.aes = FALSE, nudge_x = 11) + scale_x_date(breaks = "week") + scale_y_continuous(breaks = seq(0, 24, 2)) + theme(axis.text.x = element_text(angle = 45, hjust = 1, vjust=1)) + ggtitle("Nitrifiers in reactor 1")

#p2
#ggsave(filename = paste0("figures/",format(Sys.Date(), "%Y-%m-%d"),"_nitrifiers-fullperiod-tank1.png"), plot = p2n, width = 13, height = 7, dpi = 600)

# Tank 2
tank2 <- amp_subset_samples(nitrifiers, Tank == "02")
p3n <- amp_timeseries(tank2, time_variable = "Date", tax_aggregate = "Genus", tax_add = "Phylum", normalise = FALSE)
p4n <- p3n + scale_x_date(breaks = "week") + scale_y_continuous(breaks = seq(0, 24, 2)) + theme(axis.text.x = element_text(angle = 45)) + ggtitle("Nitrifiers in VCS tank 02")

#p4

#grid.arrange(p2n, p4n, nrow = 2)
```


Key genera in all three phases
```{r, fig.height = 10, fig.width = 15, fig.align='center', echo=T, message=FALSE, warning=FALSE}
key_genera_sub <- amp_subset_taxa(d_amp_s, tax_vector = key_genera, normalise = TRUE)


# Tank 1
key_time_tank1 <- amp_subset_samples(key_genera_sub, Tank == "01")
p1_keytime_t1 <- amp_timeseries(key_time_tank1, time_variable = "Date", tax_aggregate = "Genus", tax_add = "Phylum", normalise = FALSE)
p2_keytime_t1 <- p1_keytime_t1 + scale_x_date(breaks = "week") + scale_y_continuous(breaks = seq(0, 40, 5)) + theme(axis.text.x = element_text(angle = 45)) + ggtitle("Key genera in VCS tank 01")

# Tank 2
key_time_tank2 <- amp_subset_samples(key_genera_sub, Tank == "02")
p1_keytime_t2 <- amp_timeseries(key_time_tank2, time_variable = "Date", tax_aggregate = "Genus", tax_add = "Phylum", normalise = FALSE)
p2_keytime_t2 <- p1_keytime_t2 + scale_x_date(breaks = "week") + scale_y_continuous(breaks = seq(0, 24, 2)) + theme(axis.text.x = element_text(angle = 45)) + ggtitle("Key genera in VCS tank 02")

grid.arrange(p2_keytime_t1, p2_keytime_t2, nrow = 2)


### Look at individual species in these genera - OLB8 is just midas_s_3279; midas_g_731 is mainly midas_s_849 and a bit s_7461; Methanomethylovorans is midas_g_537 all the way; Brocadia_carolinensis drops and is as abundant as sapporoensis from mid August; Nitrosomonas battles between s5118 and s639, with s639 being more abundant from around October in tank 1, and just a bit more in tank2 around the same time; Nitrospira_defluvii is the sole species all the way through; 
key_species <- key_genera[5]
key_genera_subsp <- amp_subset_taxa(d_amp_s, tax_vector = key_species, normalise = TRUE)


# Tank 1
key_sp_time_tank1 <- amp_subset_samples(key_genera_subsp, Tank == "01")
p1_keytime_sp_t1 <- amp_timeseries(key_sp_time_tank1, time_variable = "Date", tax_aggregate = "Species", tax_add = "Genus", normalise = FALSE)
p2_keytime_sp_t1 <- p1_keytime_sp_t1 + scale_x_date(breaks = "week") + scale_y_continuous(breaks = seq(0, 24, 2)) + theme(axis.text.x = element_text(angle = 45)) + ggtitle("Key species in VCS tank 01")

# Tank 2
key_sp_time_tank2 <- amp_subset_samples(key_genera_subsp, Tank == "02")
p1_keytime_sp_t2 <- amp_timeseries(key_sp_time_tank2, time_variable = "Date", tax_aggregate = "Species", tax_add = "Genus", normalise = FALSE)
p2_keytime_sp_t2 <- p1_keytime_sp_t2 + scale_x_date(breaks = "week") + scale_y_continuous(breaks = seq(0, 24, 2)) + theme(axis.text.x = element_text(angle = 45)) + ggtitle("Key species in VCS tank 02")

grid.arrange(p2_keytime_sp_t1, p2_keytime_sp_t2, nrow = 2)

### Phase 2-3 AD genera
ad_genera <- c("Methanomethylovorans", "Thermovirga", "Methanothrix", "Methanolinea")#,"Denitratisoma", "UTBCD1")
key_genera_ad <- amp_subset_taxa(d_amp_s, tax_vector = ad_genera, normalise = TRUE)


# Tank 1
ad_time_tank1 <- amp_subset_samples(key_genera_ad, Tank == "01") %>% amp_export_long(., tax_levels = c("Phylum", "Genus")) %>% mutate(Display = paste0(Phylum, "; ", Genus)) %>%  group_by(SeqID, Date, delta_days, Display) %>% summarise(Abundance = sum(count), .groups = 'drop')

# p1_adtime_t1 <- amp_timeseries(ad_time_tank1, time_variable = "delta_days", tax_aggregate = "Genus", tax_add = "Phylum", normalise = FALSE)
# p2_adtime_t1 <- p1_adtime_t1 + scale_x_date(breaks = "week") + scale_y_continuous(breaks = seq(0, 24, 2)) + theme(axis.text.x = element_text(angle = 45)) + ggtitle("AD genera in reactor 1")

ad_genera_tank1_plot <- ggplot(ad_time_tank1, aes(x=as.numeric(delta_days), y=Abundance, color = Display)) + geom_point() + geom_line() + scale_y_continuous(breaks = seq(0, 45, 5), limits = c(0,45)) + scale_x_continuous(breaks = seq(0, 365, 25)) + theme_bw() + 
  theme(panel.grid.minor = element_blank(),
        panel.background = element_blank(),
        axis.text = element_text(size = 12),
        axis.title = element_text(size = 14),
        legend.title = element_blank(),
        panel.border = element_blank(),
        axis.line = element_line(colour = "black"),
        legend.key.size = unit(0.05, "cm"),
        legend.text = element_text(size=12),
        legend.position = c(0.17, 0.84),
        legend.margin=margin(t = 0.1, unit='cm')) + scale_color_discrete(limits=c("Euryarchaeota; Methanomethylovorans", "Synergistetes; Thermovirga", "Euryarchaeota; Methanothrix", "Euryarchaeota; Methanolinea")) + ylab("Relative read abundance (%)") + xlab("Days") +
  annotate("rect", xmin = 0, ymin=0, xmax=58, ymax=Inf, alpha=0.1) +
  annotate("text", x = 58/2, y = Inf, label = "Phase I", vjust=1, size=5) +
  annotate("rect", xmin = 58, ymin=0, xmax=58+31, ymax=Inf, alpha=0.1, fill = "blue") +
  annotate("text", x = 58+15, y = Inf, label = "Phase IIa", vjust=1, size=5) + 
  annotate("rect", xmin = 89, ymin=0, xmax=181, ymax=Inf, alpha=0.1, fill = "skyblue") +
  annotate("text", x = (181-89)/2+89, y = Inf, label = "Phase IIb", vjust=1, size=5) + 
  annotate("rect", xmin = 181, ymin=0, xmax=Inf, ymax=Inf, alpha=0.1, fill = "red") +
  annotate("text", x = (365-181)/2+181, y = Inf, label = "Phase III", vjust=1, size=5)
ggsave("figures/ad_genera_tank1_plot_defence.png", ad_genera_tank1_plot, width=12, height=5, dpi=300)
# Tank 2
ad_time_tank2 <- amp_subset_samples(key_genera_ad, Tank == "02") %>% amp_export_long(., tax_levels = c("Phylum", "Genus")) %>% mutate(Display = paste0(Phylum, "; ", Genus)) %>%  group_by(SeqID, Date, delta_days, Display) %>% summarise(Abundance = sum(count), .groups = 'drop')
# p1_adtime_t2 <- amp_timeseries(ad_time_tank2, time_variable = "Date", tax_aggregate = "Genus", tax_add = "Phylum", normalise = FALSE)
# p2_adtime_t2 <- p1_adtime_t2 + scale_x_date(breaks = "week") + scale_y_continuous(breaks = seq(0, 24, 2)) + theme(axis.text.x = element_text(angle = 45)) + ggtitle("AD genera in reactor 2")

ad_genera_tank2_plot <- ggplot(ad_time_tank2, aes(x=as.numeric(delta_days), y=Abundance, color = Display)) + geom_point() + geom_line() + scale_y_continuous(breaks = seq(0, 24, 1), limits = c(0,24)) + scale_x_continuous(breaks = seq(0, 220, 20)) + theme_bw() + 
  theme(panel.grid.minor = element_blank(),
        panel.background = element_blank(), 
        legend.title = element_blank(),
        panel.border = element_blank(),
        axis.line = element_line(colour = "black")) + scale_color_discrete(limits=c("Euryarchaeota; Methanomethylovorans", "Synergistetes; Thermovirga", "Euryarchaeota; Methanothrix", "Euryarchaeota; Methanolinea")) + ylab("Relative read abundance (%)") + xlab("Days") +
  annotate("rect", xmin = 0, ymin=0, xmax=58, ymax=24, alpha=0.1) +
  annotate("text", x = 58/2, y = 23.5, label = "Phase I") +
  annotate("rect", xmin = 58, ymin=0, xmax=58+31, ymax=24, alpha=0.1, fill = "blue") +
  annotate("text", x = 58+15, y = 23.5, label = "Phase IIa") + 
  annotate("rect", xmin = 89, ymin=0, xmax=181, ymax=24, alpha=0.1, fill = "skyblue") +
  annotate("text", x = (181-89)/2+89, y = 23.5, label = "Phase IIb") + 
  annotate("rect", xmin = 181, ymin=0, xmax=220, ymax=24, alpha=0.1, fill = "red") +
  annotate("text", x = (220-181)/2+181, y = 23.5, label = "Phase III")

# grid.arrange(ad_genera_tank1_plot, ad_genera_tank2_plot, nrow = 2)
ad_genera_plots <- cowplot::plot_grid(ad_genera_tank1_plot, ad_genera_tank2_plot, labels = c('A', 'B'), ncol = 1, align = "v")
ggsave(paste0("figures/", format(Sys.time(), "%Y-%m-%d"),"_AD-genera-all-phases-both-tanks.png"), ad_genera_plots, width = 12, height = 10, dpi=600)


## Nitrosomonas species
#nitrosomonas_genera <- c("Methanomethylovorans", "Thermovirga", "Methanothrix", "Methanolinea")#,"Denitratisoma", "UTBCD1")
nitrosomonas_sub <- amp_subset_taxa(d_amp_s, tax_vector = ad_genera, normalise = TRUE)


# Tank 1
nitrosomonas_tank1 <- amp_subset_samples(d_amp_s, Tank == "01") %>% amp_subset_taxa(tax_vector = "Nitrosomonas", normalise = TRUE) %>% amp_export_long(., tax_levels = c("Genus", "Species")) %>% mutate(Display = paste0(Genus, "; ", Species)) %>%  group_by(SeqID, Date, delta_days, Display) %>% summarise(Abundance = sum(count), .groups = 'drop')
nitro_5_abund <- nitrosomonas_tank1 %>% group_by(Display) %>% summarise(mean_abund = mean(Abundance)) %>% arrange(desc(mean_abund)) %>% head(5) %>% select(Display) %>% unlist()
nitrosomonas_tank1 <- nitrosomonas_tank1 %>% subset(Display %in% nitro_5_abund)

# p1_adtime_t1 <- amp_timeseries(ad_time_tank1, time_variable = "delta_days", tax_aggregate = "Genus", tax_add = "Phylum", normalise = FALSE)
# p2_adtime_t1 <- p1_adtime_t1 + scale_x_date(breaks = "week") + scale_y_continuous(breaks = seq(0, 24, 2)) + theme(axis.text.x = element_text(angle = 45)) + ggtitle("AD genera in reactor 1")

nitrosomonas_tank1_plot <- ggplot(nitrosomonas_tank1, aes(x=as.numeric(delta_days), y=Abundance, color = factor(Display, levels = nitro_5_abund))) + geom_point() + geom_line() + scale_y_continuous(breaks = seq(0, 4.8, 0.2), limits = c(0,4.8)) + scale_x_continuous(breaks = seq(0, 220, 20)) + theme_bw() + 
  theme(panel.grid.minor = element_blank(),
        panel.background = element_blank(), 
        legend.title = element_blank(),
        panel.border = element_blank(),
        axis.line = element_line(colour = "black")) + xlab("Days") +
  annotate("rect", xmin = 0, ymin=0, xmax=58, ymax=4.8, alpha=0.1) +
  annotate("text", x = 58/2, y = 4.7, label = "Phase I") +
  annotate("rect", xmin = 58, ymin=0, xmax=58+31, ymax=4.8, alpha=0.1, fill = "blue") +
  annotate("text", x = 58+15, y = 4.7, label = "Phase IIa") + 
  annotate("rect", xmin = 89, ymin=0, xmax=181, ymax=4.8, alpha=0.1, fill = "skyblue") +
  annotate("text", x = (181-89)/2+89, y = 4.7, label = "Phase IIb") + 
  annotate("rect", xmin = 181, ymin=0, xmax=220, ymax=4.8, alpha=0.1, fill = "red") +
  annotate("text", x = (220-181)/2+181, y = 4.7, label = "Phase III")

# Tank 2
nitrosomonas_tank2 <- amp_subset_samples(d_amp_s, Tank == "02") %>% amp_subset_taxa(tax_vector = "Nitrosomonas", normalise = TRUE) %>% amp_export_long(., tax_levels = c("Genus", "Species")) %>% mutate(Display = paste0(Genus, "; ", Species)) %>%  group_by(SeqID, Date, delta_days, Display) %>% summarise(Abundance = sum(count), .groups = 'drop')
nitro_5_abund <- nitrosomonas_tank2 %>% group_by(Display) %>% summarise(mean_abund = mean(Abundance)) %>% arrange(desc(mean_abund)) %>% head(5) %>% select(Display) %>% unlist()
nitrosomonas_tank2 <- nitrosomonas_tank2 %>% subset(Display %in% nitro_5_abund)

# p1_adtime_t1 <- amp_timeseries(ad_time_tank1, time_variable = "delta_days", tax_aggregate = "Genus", tax_add = "Phylum", normalise = FALSE)
# p2_adtime_t1 <- p1_adtime_t1 + scale_x_date(breaks = "week") + scale_y_continuous(breaks = seq(0, 24, 2)) + theme(axis.text.x = element_text(angle = 45)) + ggtitle("AD genera in reactor 1")

nitrosomonas_tank2_plot <- ggplot(nitrosomonas_tank2, aes(x=as.numeric(delta_days), y=Abundance, color = factor(Display, levels = nitro_5_abund))) + geom_point() + geom_line() + scale_y_continuous(breaks = seq(0, 4.8, 0.2), limits = c(0,4.8)) + scale_x_continuous(breaks = seq(0, 220, 20)) + theme_bw() + 
  theme(panel.grid.minor = element_blank(),
        panel.background = element_blank(), 
        legend.title = element_blank(),
        panel.border = element_blank(),
        axis.line = element_line(colour = "black")) + xlab("Days")  +
  annotate("rect", xmin = 0, ymin=0, xmax=58, ymax=4.8, alpha=0.1) +
  annotate("text", x = 58/2, y = 4.7, label = "Phase I") +
  annotate("rect", xmin = 58, ymin=0, xmax=58+31, ymax=4.8, alpha=0.1, fill = "blue") +
  annotate("text", x = 58+15, y = 4.7, label = "Phase IIa") + 
  annotate("rect", xmin = 89, ymin=0, xmax=181, ymax=4.8, alpha=0.1, fill = "skyblue") +
  annotate("text", x = (181-89)/2+89, y = 4.7, label = "Phase IIb") + 
  annotate("rect", xmin = 181, ymin=0, xmax=220, ymax=4.8, alpha=0.1, fill = "red") +
  annotate("text", x = (220-181)/2+181, y = 4.7, label = "Phase III")

# grid.arrange(ad_genera_tank1_plot, ad_genera_tank2_plot, nrow = 2)
nitrosomonas_plots <- cowplot::plot_grid(nitrosomonas_tank1_plot, nitrosomonas_tank2_plot, labels = c('A', 'B'), ncol = 1, align = "v")

#ggsave(paste0("figures/", format(Sys.time(), "%Y-%m-%d"),"_Nitrosomonas-all-phases-both-tanks.png"), nitrosomonas_plots, width = 12, height = 10, dpi=600)
```


#### NOB/AOB ratio plots
Figure x - NOB/AOB ratios and Nitromonas species
```{r}
phase_txt_size = 5

## Nitrosomonas species
nitrosomonas_sub <- amp_subset_taxa(d_amp_s, tax_vector = "Nitrosomonas", normalise = TRUE)

nitrosomonas_tank1 <- amp_subset_samples(d_amp_s, Tank == "01" & !(samplingSpot %in% c("overflow", "hydrocyclone"))) %>% amp_subset_taxa(tax_vector = "Nitrosomonas", normalise = TRUE) %>% amp_export_long(., tax_levels = c("Species")) %>%  group_by(SeqID, Date, delta_days, Species) %>% summarise(Abundance = sum(count), .groups = 'drop')

nitro_5_abund <- nitrosomonas_tank1 %>% group_by(Species) %>% summarise(mean_abund = mean(Abundance)) %>% arrange(desc(mean_abund)) %>% head(5) %>% select(Species) %>% unlist()


tank1_nitrosomonas <- amp_subset_taxa(tank1_all_phases, tax_vector = nitro_5_abund, normalise = TRUE) %>% amp_export_long(., tax_levels = c("Species")) %>%  group_by(SeqID, Date, delta_days, Species) %>% summarise(Abundance = sum(count), .groups = 'drop') %>% mutate(week = lubridate::week(Date)) %>% group_by(Species) %>% mutate(mean_07d = rollmean(Abundance, k = 5, fill = NA), mean_14d = rollmean(Abundance, k = 10, fill = NA))

tank1_brocadia <- amp_subset_taxa(tank1_all_phases, tax_vector = "Ca_Brocadia", normalise = TRUE) %>% amp_export_long(., tax_levels = c("Species")) %>%  group_by(SeqID, Date, delta_days, Species) %>% summarise(Abundance = sum(count), .groups = 'drop') %>% mutate(week = lubridate::week(Date)) %>% group_by(Species) %>% mutate(mean_07d = rollmean(Abundance, k = 5, fill = NA), mean_14d = rollmean(Abundance, k = 10, fill = NA))

# Tank 1


nitrosomonas_tank1_plot <- ggplot(tank1_nitrosomonas, aes(x=delta_days, y=Abundance, color = factor(Species, levels = nitro_5_abund))) + geom_point() + geom_line(aes(x=delta_days, y = mean_14d, color=factor(Species, levels = nitro_5_abund))) + scale_y_continuous(breaks = seq(0, 4.8, 0.4), limits = c(0,4.8)) + scale_x_continuous(breaks = seq(-150, 365, 25), limits=c(-150,365)) + theme_bw() + 
  theme(axis.text=element_text(size=12),
        axis.title=element_text(size=14,face="bold"),
        axis.line = element_line(colour = "black"),
        panel.grid.minor = element_blank(),
        panel.background = element_blank(), 
        legend.title = element_blank(),
        panel.border = element_blank(),
        legend.key.size = unit(0.05, "cm"),
        legend.text = element_text(size = 10),
        legend.position = c(0.89, 0.74),
        legend.margin=margin(t = 0.1, unit='cm'))+ 
  xlab("Day") + ylab("Read abundance (%)") +
  annotate("rect", xmin = 0, ymin=0, xmax=58, ymax=Inf, alpha=0.1) +
  annotate("text", x = 58/2, y = 4.7, label = "Phase I", size=phase_txt_size) +
  annotate("rect", xmin = 58, ymin=0, xmax=58+31, ymax=Inf, alpha=0.1, fill = "blue") +
  annotate("text", x = 58+15, y = 4.7, label = "Phase IIa", size=phase_txt_size) + 
  annotate("rect", xmin = 89, ymin=0, xmax=181, ymax=Inf, alpha=0.1, fill = "skyblue") +
  annotate("text", x = (181-89)/2+89, y = 4.7, label = "Phase IIb", size=phase_txt_size) + 
  annotate("rect", xmin = 181, ymin=-Inf, xmax=365, ymax=Inf, alpha=0.1, fill = "red") +
  annotate("text", x = (365-181)/2+181, y = 4.7, label = "Phase III", size=phase_txt_size)


brocadia_tank1_plot <- ggplot(tank1_brocadia, aes(x=delta_days, y=Abundance, color = Species)) + geom_point() + geom_line(aes(x=delta_days, y = mean_14d, color=Species)) + scale_y_continuous(breaks = seq(0, 18, 2), limits = c(0,18)) + scale_x_continuous(breaks = seq(-150, 365, 25), limits=c(-150,365)) + theme_bw() + 
  theme(axis.text=element_text(size=12),
        axis.title=element_text(size=14,face="bold"),
        axis.line = element_line(colour = "black"),
        panel.grid.minor = element_blank(),
        panel.background = element_blank(), 
        legend.title = element_blank(),
        panel.border = element_blank(),
        legend.key.size = unit(0.05, "cm"),
        legend.text = element_text(size = 10),
        legend.position = c(0.89, 0.74),
        legend.margin=margin(t = 0.1, unit='cm')) + 
  xlab("Day") + ylab("Read abundance (%)") +
  annotate("rect", xmin = 0, ymin=0, xmax=58, ymax=Inf, alpha=0.1) +
  annotate("text", x = 58/2, y = 18, label = "Phase I", size=phase_txt_size) +
  annotate("rect", xmin = 58, ymin=0, xmax=58+31, ymax=Inf, alpha=0.1, fill = "blue") +
  annotate("text", x = 58+15, y = 18, label = "Phase IIa", size=phase_txt_size) + 
  annotate("rect", xmin = 89, ymin=0, xmax=181, ymax=Inf, alpha=0.1, fill = "skyblue") +
  annotate("text", x = (181-89)/2+89, y = 18, label = "Phase IIb", size=phase_txt_size) + 
  annotate("rect", xmin = 181, ymin=-Inf, xmax=365, ymax=Inf, alpha=0.1, fill = "red") +
  annotate("text", x = (365-181)/2+181, y = 18, label = "Phase III", size=phase_txt_size)


#nob_aob_nitro_plots1 <- cowplot::plot_grid(plot_nitrifiers_tank1, brocadia_tank1_plot,nitrosomonas_tank1_plot, nob_aob, nob_aob_meanvelocity, labels = c('A', 'B', 'C', 'D', 'E'), ncol = 1, align = "v")

#ggsave(filename = paste0("figures/",format(Sys.Date(), "%Y-%m-%d"),"_nob_aob_nitrosomonas-fullperiod-tank1.png"), plot = nob_aob_nitro_plots1, width = 12, height = 12.5, dpi = 600)



# Tank 2

tank2_nitrosomonas <- amp_subset_taxa(tank2_all_phases, tax_vector = nitro_5_abund, normalise = TRUE) %>% amp_export_long(., tax_levels = c("Species")) %>%  group_by(SeqID, Date, delta_days, Species) %>% summarise(Abundance = sum(count), .groups = 'drop') %>% mutate(week = lubridate::week(Date)) %>% group_by(Species) %>% mutate(mean_07d = rollmean(Abundance, k = 5, fill = NA), mean_14d = rollmean(Abundance, k = 10, fill = NA))

tank2_brocadia <- amp_subset_taxa(tank2_all_phases, tax_vector = "Ca_Brocadia", normalise = TRUE) %>% amp_export_long(., tax_levels = c("Species")) %>%  group_by(SeqID, Date, delta_days, Species) %>% summarise(Abundance = sum(count), .groups = 'drop') %>% mutate(week = lubridate::week(Date)) %>% group_by(Species) %>% mutate(mean_07d = rollmean(Abundance, k = 5, fill = NA), mean_14d = rollmean(Abundance, k = 10, fill = NA))


#nitrosomonas_tank2 <- amp_subset_samples(d_amp_s, Tank == "02") %>% amp_subset_taxa(tax_vector = "Nitrosomonas", normalise = TRUE) %>% amp_export_long(., tax_levels = c("Genus", "Species")) %>% mutate(Display = paste0(Genus, "; ", Species)) %>%  group_by(SeqID, Date, delta_days, Display) %>% summarise(Abundance = sum(count), .groups = 'drop')
#nitro_5_abund_t2 <- nitrosomonas_tank2 %>% group_by(Display) %>% summarise(mean_abund = mean(Abundance)) %>% arrange(desc(mean_abund)) %>% head(5) %>% select(Display) %>% unlist()
#nitrosomonas_tank2 <- nitrosomonas_tank2 %>% subset(Display %in% nitro_5_abund)

nitrosomonas_tank2_plot <- ggplot(tank2_nitrosomonas, aes(x=delta_days, y=Abundance, color = factor(Species, levels = nitro_5_abund))) + geom_point() + geom_line(aes(x=delta_days, y = mean_14d, color=factor(Species, levels = nitro_5_abund))) + scale_y_continuous(breaks = seq(0, 4.8, 0.4), limits = c(0,4.8)) + scale_x_continuous(breaks = seq(-150, 365, 25), limits=c(-150,365)) + theme_bw() + 
  theme(axis.text=element_text(size=12),
        axis.title=element_text(size=14,face="bold"),
        axis.line = element_line(colour = "black"),
        panel.grid.minor = element_blank(),
        panel.background = element_blank(), 
        legend.title = element_blank(),
        panel.border = element_blank(),
        legend.key.size = unit(0.05, "cm"),
        legend.text = element_text(size = 10),
        legend.position = c(0.89, 0.74),
        legend.margin=margin(t = 0.1, unit='cm')) + 
  xlab("Day") + ylab("Read abundance (%)") +
  annotate("rect", xmin = 0, ymin=0, xmax=58, ymax=Inf, alpha=0.1) +
  annotate("text", x = 58/2, y = 4.7, label = "Phase I", size=phase_txt_size) +
  annotate("rect", xmin = 58, ymin=0, xmax=58+31, ymax=Inf, alpha=0.1, fill = "blue") +
  annotate("text", x = 58+15, y = 4.7, label = "Phase IIa", size=phase_txt_size) + 
  annotate("rect", xmin = 89, ymin=0, xmax=181, ymax=Inf, alpha=0.1, fill = "skyblue") +
  annotate("text", x = (181-89)/2+89, y = 4.7, label = "Phase IIb", size=phase_txt_size) + 
  annotate("rect", xmin = 181, ymin=-Inf, xmax=365, ymax=Inf, alpha=0.1, fill = "red") +
  annotate("text", x = (365-181)/2+181, y = 4.7, label = "Phase III", size=phase_txt_size)

brocadia_tank2_plot <- ggplot(tank2_brocadia, aes(x=delta_days, y=Abundance, color = Species)) + geom_point() + geom_line(aes(x=delta_days, y = mean_14d, color=Species)) + scale_y_continuous(breaks = seq(0, 18, 2), limits = c(0,18)) + scale_x_continuous(breaks = seq(-150, 365, 25), limits=c(-150,365)) + theme_bw() + 
  theme(axis.text=element_text(size=12),
        axis.title=element_text(size=14,face="bold"),
        axis.line = element_line(colour = "black"),
        panel.grid.minor = element_blank(),
        panel.background = element_blank(), 
        legend.title = element_blank(),
        panel.border = element_blank(),
        legend.key.size = unit(0.05, "cm"),
        legend.text = element_text(size = 10),
        legend.position = c(0.89, 0.74),
        legend.margin=margin(t = 0.1, unit='cm')) + 
  xlab("Day") + ylab("Read abundance (%)") +
  annotate("rect", xmin = 0, ymin=0, xmax=58, ymax=Inf, alpha=0.1) +
  annotate("text", x = 58/2, y = 18, label = "Phase I", size=phase_txt_size) +
  annotate("rect", xmin = 58, ymin=0, xmax=58+31, ymax=Inf, alpha=0.1, fill = "blue") +
  annotate("text", x = 58+15, y = 18, label = "Phase IIa", size=phase_txt_size) + 
  annotate("rect", xmin = 89, ymin=0, xmax=181, ymax=Inf, alpha=0.1, fill = "skyblue") +
  annotate("text", x = (181-89)/2+89, y = 18, label = "Phase IIb", size=phase_txt_size) + 
  annotate("rect", xmin = 181, ymin=-Inf, xmax=365, ymax=Inf, alpha=0.1, fill = "red") +
  annotate("text", x = (365-181)/2+181, y = 18, label = "Phase III", size=phase_txt_size)


#nob_aob_nitro_plots2 <- cowplot::plot_grid(plot_nitrifiers_tank2, brocadia_tank2_plot, nitrosomonas_tank2_plot, nob_aob_t2, nob_aob_meanvelocity_t2, labels = c('A', 'B', 'C', 'D', 'E'), ncol = 1, align = "v")

#ggsave(filename = paste0("figures/",format(Sys.Date(), "%Y-%m-%d"),"_nob_aob_nitrosomonas-fullperiod-tank2.png"), plot = nob_aob_nitro_plots2, width = 12, height = 12.5, dpi = 600)
```

Figure 4 - AD community and heatmap all phases
```{r, fig.height = 10, fig.width = 15, fig.align='center', echo=T, message=FALSE, warning=FALSE}
# Tank 1

select_ad_samples <- c(0, 8, 15, 23, 30, 37, 44, 51, 57, 64, 71, 78, 85, 92, 99, 106, 113, 120, 127, 134, 141, 148, 155, 162, 169, 175, 183, 190, 197, 204, 212, 219, 226, 233, 245, 253, 261, 268, 275, 284, 291, 298, 305, 312, 319, 326, 339, 347, 354, 359)
tank1_allphase_selectdays <- amp_subset_samples(tank1_all_phases, delta_days %in% select_ad_samples)

tank1_all_phases_heatmap <- amp_heatmap(tank1_allphase_selectdays,
            group_by = c("delta_days"),
            #facet_by = "Tank",
            tax_aggregate = "Genus",
            tax_add = "Phylum",
            plot_colorscale = "sqrt",
            min_abundance = 0.3,
            max_abundance = 20,
            tax_show = 25,
            #color_vector = c("white", "red"),
            plot_values_size = 3, textmap=F,
            plot_values = F,
            #plot_legendbreaks = c(1, 5, 10, 20),
            plot_functions = F) + #,
            #functions = c("AOB", "NOB"), 
            #rel_widths = c(0.9, 0.10)) 
  theme(axis.text.x = element_text(size = 10, angle=90),#, hjust = 1, vjust = 1),
        #axis.text.x = element_text(angle = 90),
        axis.text.y = element_text(size=10),
        legend.position = "bottom")

### AD genera
ad_genera <- c("Methanomethylovorans", "Thermovirga", "Methanothrix", "Methanolinea")
key_genera_ad <- amp_subset_taxa(d_amp_s, tax_vector = ad_genera, normalise = TRUE)




ad_time_tank1 <- amp_subset_samples(key_genera_ad, Tank == "01") %>% amp_export_long(., tax_levels = c("Phylum", "Genus")) %>% mutate(Display = paste0(Phylum, "; ", Genus)) %>%  group_by(SeqID, Date, delta_days, Display) %>% summarise(Abundance = sum(count), .groups = 'drop')


ad_genera_tank1_plot <- ggplot(ad_time_tank1, aes(x=as.numeric(delta_days), y=Abundance, color = Display)) + geom_point() + geom_line() + scale_y_continuous(breaks = seq(0, 45, 5), limits = c(0,45)) + scale_x_continuous(breaks = seq(0, 350, 25)) + theme_bw() + 
  theme(panel.grid.minor = element_blank(),
        panel.background = element_blank(), 
        legend.title = element_blank(),
        legend.text = element_text(size=10),
        legend.key.size = unit(0.05, "cm"),
        legend.position = c(0.125, 0.76),
        legend.margin=margin(t = 0.1, unit='cm'),
        panel.border = element_blank(),
        axis.line = element_line(colour = "black")) + scale_color_discrete(limits=c("Euryarchaeota; Methanomethylovorans", "Synergistetes; Thermovirga", "Euryarchaeota; Methanothrix", "Euryarchaeota; Methanolinea")) + ylab("Relative read abundance (%)") + xlab("Days") +
  annotate("rect", xmin = 0, ymin=0, xmax=58, ymax=Inf, alpha=0.1) +
  annotate("text", x = 58/2, y = 44.5, label = "Phase I") +
  annotate("rect", xmin = 58, ymin=0, xmax=58+31, ymax=Inf, alpha=0.1, fill = "blue") +
  annotate("text", x = 58+15, y = 44.5, label = "Phase IIa") + 
  annotate("rect", xmin = 89, ymin=0, xmax=181, ymax=Inf, alpha=0.1, fill = "skyblue") +
  annotate("text", x = (181-89)/2+89, y = 44.5, label = "Phase IIb") + 
  annotate("rect", xmin = 181, ymin=0, xmax=359, ymax=Inf, alpha=0.1, fill = "red") +
  annotate("text", x = (359-181)/2+181, y = 44.5, label = "Phase III")



# Tank 2

ad_time_tank2 <- amp_subset_samples(key_genera_ad, Tank == "02") %>% amp_export_long(., tax_levels = c("Phylum", "Genus")) %>% mutate(Display = paste0(Phylum, "; ", Genus)) %>%  group_by(SeqID, Date, delta_days, Display) %>% summarise(Abundance = sum(count), .groups = 'drop')

ad_genera_tank2_plot <- ggplot(ad_time_tank2, aes(x=as.numeric(delta_days), y=Abundance, color = Display)) + geom_point() + geom_line() + scale_y_continuous(breaks = seq(0, 45, 5), limits = c(0,45)) + scale_x_continuous(breaks = seq(0, 350, 25)) + theme_bw() + 
  theme(panel.grid.minor = element_blank(),
        panel.background = element_blank(), 
        legend.title = element_blank(),
        legend.text = element_text(size=10),
        legend.key.size = unit(0.05, "cm"),
        legend.position = c(0.125, 0.76),
        legend.margin=margin(t = 0.1, unit='cm'),
        panel.border = element_blank(),
        axis.line = element_line(colour = "black")) + scale_color_discrete(limits=c("Euryarchaeota; Methanomethylovorans", "Synergistetes; Thermovirga", "Euryarchaeota; Methanothrix", "Euryarchaeota; Methanolinea")) + ylab("Relative read abundance (%)") + xlab("Days") +
  annotate("rect", xmin = 0, ymin=0, xmax=58, ymax=Inf, alpha=0.1) +
  annotate("text", x = 58/2, y = 44.5, label = "Phase I") +
  annotate("rect", xmin = 58, ymin=0, xmax=58+31, ymax=Inf, alpha=0.1, fill = "blue") +
  annotate("text", x = 58+15, y = 44.5, label = "Phase IIa") + 
  annotate("rect", xmin = 89, ymin=0, xmax=181, ymax=Inf, alpha=0.1, fill = "skyblue") +
  annotate("text", x = (181-89)/2+89, y = 44.5, label = "Phase IIb") + 
  annotate("rect", xmin = 181, ymin=0, xmax=359, ymax=Inf, alpha=0.1, fill = "red") +
  annotate("text", x = (359-181)/2+181, y = 44.5, label = "Phase III")

heatmap_ad_genera_plots <- cowplot::plot_grid(tank1_all_phases_heatmap, ad_genera_tank1_plot, ad_genera_tank2_plot, labels = c('A', 'B', 'C'), ncol = 1, rel_heights = c(1.9,1,1))#, align = "v")

ggsave(paste0("figures/", format(Sys.time(), "%Y-%m-%d"),"_heatmap-AD-genera-all-phases.png"), heatmap_ad_genera_plots, width = 12, height = 12, dpi=300)

```


### Combined biological + physicochemical
PCA with environmental fit and species
```{r, message=FALSE, warning=FALSE}
amp_ordinate(d_amp_s,
             type = "PCA",
             transform = "hellinger",
             sample_color_by = "Tank",
             envfit_numeric = c("NH4", "NO2", "NO3", "Temp", "pH", "O2"),
             species_plot = TRUE,
             species_nlabels = 5,
             species_plotly = TRUE)
```
It would seem that UTBCD1 grows in abundance with higher pH, and it is inverse with Ca. Brocadia. Nitrosomonas is slightly positively correlated with the growth of Ca. Brocadia. The Methanomethylovoran is strongly correlated with O2 levels, which sounds really weird. The dataset only consists of 130 full observations though (`r metadata_extra %>% subset(Tank == "01") %>% select(pH) %>% drop_na() %>% nrow()` for Tank 01 and `r metadata_extra %>% subset(Tank == "02") %>% select(pH) %>% drop_na() %>% nrow()` for Tank 02).


### Physicochemical data
##### Stats
```{r message=FALSE, warning=FALSE}
all_data_smooth_daily <- all_data_smooth %>% mutate(delta_days = round(delta_hours/24, 0),
                                                    phase = case_when(delta_days<0 ~ "normal_operation",
                                                                      delta_days >= 0 & delta_days < 58 ~ "phase_I",
                                                                      delta_days >= 58 & delta_days < 89 ~ "phase_IIa",
                                                                      delta_days >= 89 & delta_days < 181 ~ "phase_IIb",
                                                                      delta_days >= 181 ~ "phase_III"),
                                                    value = mean)

daily_HRT <- all_data_smooth_daily %>% subset(variable == "Centrate_in") %>% drop_na(mean) %>% 
  group_by(delta_days, Tank) %>% 
  summarise(HRT = 320/sum(mean))

daily_N_load <- all_data_smooth_daily %>% subset(variable == "NH4_in") %>% drop_na(mean) %>% 
  group_by(delta_days, phase, Tank) %>% 
  summarise(N_load = sum(mean)/320) %>% 
  group_by(phase, Tank) %>% 
  summarise(minimum = round(min(N_load, na.rm = TRUE),2), maximum = round(max(N_load, na.rm = TRUE),2), mean = round(mean(N_load, na.rm = TRUE),2), median = round(median(N_load, na.rm = TRUE),2), sd = round(sd(N_load, na.rm = TRUE),2))

stats_phases <- all_data_smooth_daily %>% subset(!(variable %in% c("AirFlow", "NH4_out", "N_converted", "Water_in", "Flow_hydrocyclone", "Flow_feedtank", "Centrate_in", "N2O", "NH4_remove")) & datatype == "sensor") %>% group_by(phase, Tank, variable) %>% summarise(minimum = round(min(value, na.rm = TRUE),2), maximum = round(max(value, na.rm = TRUE),2), mean = round(mean(value, na.rm = TRUE),2), median = round(median(value, na.rm = TRUE),2), sd = round(sd(value, na.rm = TRUE),2))

stats_phases_1 <- stats_phases %>% subset(Tank == 1) %>% subset(variable %in% c("O2", "HRT", "Temp", "pH"))
stats_phases_2 <- stats_phases %>% subset(Tank == 2) %>% subset(variable %in% c("O2", "HRT", "Temp", "pH"))

stats_phases %>% subset(variable == "NH4")# %>% mutate(mean_N = mean/320) #%>% select(-c(minimum, maximum, median))
```

Check O2 requirements for heterotrophic denitrification
```{r}
stats_O2 <- all_data_smooth_daily %>% subset(variable %in% c("NH4_in", "O2", "AirFlow") & datatype == "sensor") %>% group_by(phase, Tank, variable) %>% summarise(minimum = round(min(value, na.rm = TRUE),2), maximum = round(max(value, na.rm = TRUE),2), mean = round(mean(value, na.rm = TRUE),2), median = round(median(value, na.rm = TRUE),2), sd = round(sd(value, na.rm = TRUE),2))

# Conventional nitrification/denitrification (https://www.sciencedirect.com/science/article/pii/S0960852418305625) needs 4.57g O2/g N, PNA is 2.74. Atmospheric (dry) air is 1.3 kg/m3, 21% O2
stats_O2_1 <- stats_O2 %>% mutate(cnd_O2_needed = case_when(variable == "NH4_in" ~ mean*1000*4.57), pna_O2_needed = case_when(variable == "NH4_in" ~ mean*1000*2.74), O2_pumped = case_when(variable == "AirFlow" ~ mean*1.3*1000*0.21))
```


Figure 3 - NH4 and nitrifiers plots
```{r}
all_data_smooth_daily2 <- all_data_smooth_daily %>% subset(!(variable == "NRE" & newMean >1.0))

stats_phases_new <- all_data_smooth_daily2 %>% 
  #subset(!(variable == "NRE" & newMean >100)) %>% 
  mutate(newPhase = case_when(
    phase == "normal_operation" | phase == "phase_I" ~ "baseline", 
    TRUE ~ phase)) %>% 
  group_by(newPhase, Tank, variable) %>% 
  summarise(minimum = round(min(value, na.rm = TRUE),2), maximum = round(max(value, na.rm = TRUE),2), mean = round(mean(value, na.rm = TRUE),2), median = round(median(value, na.rm = TRUE),2), sd = round(sd(value, na.rm = TRUE),2))

threshold_levels <- stats_phases_new %>% subset(newPhase == "baseline") %>% mutate(lower_limit = mean-1.5*sd, upper_limit = mean+1.5*sd)

### SELECT ###
select_var = "NH4"
select_tank = "1"

###        ###


plot_threshold <- ggplot(subset(all_data_smooth_daily2, variable == select_var & Tank == select_tank), aes(x=delta_hours, y=newMean)) +
  geom_point(alpha=0.1) + 
  geom_smooth() +
  scale_x_continuous(labels=function(x)round(x/24, 0), breaks = seq(-150*24, 365*24, 25*24), limits = c(-150*24, 365*24)) +
  scale_y_continuous(breaks = seq(0, 250, 50), limits = c(0, 250)) +
  xlab("Day") +
  ylab(paste0("NH4 conc. (mg/L)")) + 
  annotate("rect", xmin = 0, ymin=-Inf, xmax=58*24, ymax=Inf, alpha=0.1) +
  annotate("text", x = (58/2)*24, y = Inf, label = "Phase I", vjust = 1, size=phase_txt_size) +
  annotate("rect", xmin = 58*24, ymin=-Inf, xmax=(58+31)*24, ymax=Inf, alpha=0.1, fill = "blue") +
  annotate("text", x = (58+15)*24, y = Inf, label = "Phase IIa", vjust = 1, size=phase_txt_size) + 
  annotate("rect", xmin = 89*24, ymin=-Inf, xmax=181*24, ymax=Inf, alpha=0.1, fill = "skyblue") +
  annotate("text", x = ((181-89)/2+89)*24, y = Inf, label = "Phase IIb", vjust = 1, size=phase_txt_size) + 
  annotate("rect", xmin = 181*24, ymin=-Inf, xmax=365*24, ymax=Inf, alpha=0.1, fill = "red") +
  annotate("text", x = ((365-181)/2+181)*24, y = Inf, label = "Phase III", vjust = 1, size=phase_txt_size) +
  geom_hline(aes(yintercept = upper_limit), subset(threshold_levels, variable == select_var & Tank == select_tank)) +
  geom_hline(aes(yintercept = lower_limit), subset(threshold_levels, variable == select_var & Tank == select_tank)) + theme_bw() + 
  theme(axis.text=element_text(size=12),
        axis.title=element_text(size=14,face="bold"),
        axis.line = element_line(colour = "black"),
        panel.grid.minor = element_blank(),
        panel.background = element_blank(), 
        legend.title = element_blank(),
        panel.border = element_blank()
        )

plot_threshold1 <- ggplot(subset(all_data_smooth_daily2, variable == "NH4_efficiency" & Tank == select_tank), aes(x=delta_hours, y=newMean)) +
  geom_point(alpha=0.1) + 
  geom_smooth() +
  scale_x_continuous(labels=function(x)round(x/24, 0), breaks = seq(-150*24, 365*24, 25*24), limits = c(-150*24, 365*24)) +
  scale_y_continuous(breaks = seq(75, 100, 5), limits = c(75, 100)) +
  xlab("Day") +
  ylab(paste0("NH4 removal eff. (%)")) + 
  annotate("rect", xmin = 0, ymin=-Inf, xmax=58*24, ymax=Inf, alpha=0.1) +
  annotate("text", x = (58/2)*24, y = Inf, label = "Phase I", vjust = 1, size=phase_txt_size) +
  annotate("rect", xmin = 58*24, ymin=-Inf, xmax=(58+31)*24, ymax=Inf, alpha=0.1, fill = "blue") +
  annotate("text", x = (58+15)*24, y = Inf, label = "Phase IIa", vjust = 1, size=phase_txt_size) + 
  annotate("rect", xmin = 89*24, ymin=-Inf, xmax=181*24, ymax=Inf, alpha=0.1, fill = "skyblue") +
  annotate("text", x = ((181-89)/2+89)*24, y = Inf, label = "Phase IIb", vjust = 1, size=phase_txt_size) + 
  annotate("rect", xmin = 181*24, ymin=-Inf, xmax=365*24, ymax=Inf, alpha=0.1, fill = "red") +
  annotate("text", x = ((365-181)/2+181)*24, y = Inf, label = "Phase III", vjust = 1, size=phase_txt_size) +
  geom_hline(aes(yintercept = upper_limit), subset(threshold_levels, variable == "NH4_efficiency" & Tank == select_tank)) +
  geom_hline(aes(yintercept = lower_limit), subset(threshold_levels, variable == "NH4_efficiency" & Tank == select_tank)) + theme_bw() + 
  theme(axis.text=element_text(size=12),
        axis.title=element_text(size=14,face="bold"),
        axis.line = element_line(colour = "black"),
        panel.grid.minor = element_blank(),
        panel.background = element_blank(), 
        legend.title = element_blank(),
        panel.border = element_blank()
        )


plot_nitrifiers_tank1_new <- ggplot(tank1_nitrifiers, aes(x=delta_days, y=Abundance, color = Display)) + geom_point() + geom_line(aes(x=delta_days, y=mean_14d, color = Display)) + scale_y_continuous(breaks = seq(0, 24, 2)) + scale_x_continuous(breaks = seq(-150, 365, 25), limits=c(-150,365)) + theme_bw() + 
  theme(axis.text=element_text(size=12),
        axis.title=element_text(size=14,face="bold"),
        axis.line = element_line(colour = "black"),
        panel.grid.minor = element_blank(),
        panel.background = element_blank(), 
        legend.title = element_blank(),
        panel.border = element_blank(),
        legend.key.size = unit(0.05, "cm"),
        legend.text = element_text(size = 10),
        legend.position = c(0.89, 0.74),
        legend.margin=margin(t = 0.1, unit='cm'))  + scale_color_discrete(limits=c("Planctomycetes; Ca_Brocadia", "Proteobacteria; Nitrosomonas", "Nitrospirae; Nitrospira")) + ylab("Read abundance (%)") + xlab("Day") + 
  annotate("rect", xmin = 0, ymin=0, xmax=58, ymax=Inf, alpha=0.1) +
  annotate("text", x = 58/2, y = 25, label = "Phase I", size=phase_txt_size) +
  annotate("rect", xmin = 58, ymin=0, xmax=58+31, ymax=Inf, alpha=0.1, fill = "blue") +
  annotate("text", x = 58+15, y = 25, label = "Phase IIa", size=phase_txt_size) + 
  annotate("rect", xmin = 89, ymin=0, xmax=181, ymax=Inf, alpha=0.1, fill = "skyblue") +
  annotate("text", x = (181-89)/2+89, y = 25, label = "Phase IIb", size=phase_txt_size) + 
  annotate("rect", xmin = 181, ymin=0, xmax=365, ymax=Inf, alpha=0.1, fill = "red") +
  annotate("text", x = (365-181)/2+181, y = 25, label = "Phase III", size=phase_txt_size)



p_fig3 <- cowplot::plot_grid(plot_threshold, plot_threshold1, plot_nitrifiers_tank1_new, brocadia_tank1_plot, nitrosomonas_tank1_plot, ncol = 1, align = "v", axis = "b", labels = c('A', 'B', 'C', 'D', 'E'))
ggsave(filename = paste0("figures/",format(Sys.Date(), "%Y-%m-%d"),"_figure3_nh4-nitrifiers-alltime-tank1.png"), plot = p_fig3, width = 15, height = 14.5, dpi = 600)
```


Figure S6 - NH4 and nitrifiers plots, tank 2
```{r}
all_data_smooth_daily2 <- all_data_smooth_daily %>% subset(!(variable == "NRE" & newMean >1.0))

stats_phases_new <- all_data_smooth_daily2 %>% 
  #subset(!(variable == "NRE" & newMean >100)) %>% 
  mutate(newPhase = case_when(
    phase == "normal_operation" | phase == "phase_I" ~ "baseline", 
    TRUE ~ phase)) %>% 
  group_by(newPhase, Tank, variable) %>% 
  summarise(minimum = round(min(value, na.rm = TRUE),2), maximum = round(max(value, na.rm = TRUE),2), mean = round(mean(value, na.rm = TRUE),2), median = round(median(value, na.rm = TRUE),2), sd = round(sd(value, na.rm = TRUE),2))

threshold_levels <- stats_phases_new %>% subset(newPhase == "baseline") %>% mutate(lower_limit = mean-1.5*sd, upper_limit = mean+1.5*sd)

### SELECT ###
select_var = "NH4"
select_tank = "2"
###        ###


plot_threshold_t2 <- ggplot(subset(all_data_smooth_daily2, variable == select_var & Tank == select_tank), aes(x=delta_hours, y=newMean)) +
  geom_point(alpha=0.1) + 
  geom_smooth() +
  scale_x_continuous(labels=function(x)round(x/24, 0), breaks = seq(-150*24, 365*24, 25*24), limits = c(-150*24, 365*24)) +
  scale_y_continuous(breaks = seq(0, 250, 50), limits = c(0, 250)) +
  xlab("Day") +
  ylab(paste0("NH4 conc. (mg/L)")) + 
  annotate("rect", xmin = 0, ymin=-Inf, xmax=58*24, ymax=Inf, alpha=0.1) +
  annotate("text", x = (58/2)*24, y = Inf, label = "Phase I", vjust = 1, size=phase_txt_size) +
  annotate("rect", xmin = 58*24, ymin=-Inf, xmax=(58+31)*24, ymax=Inf, alpha=0.1, fill = "blue") +
  annotate("text", x = (58+15)*24, y = Inf, label = "Phase IIa", vjust = 1, size=phase_txt_size) + 
  annotate("rect", xmin = 89*24, ymin=-Inf, xmax=181*24, ymax=Inf, alpha=0.1, fill = "skyblue") +
  annotate("text", x = ((181-89)/2+89)*24, y = Inf, label = "Phase IIb", vjust = 1, size=phase_txt_size) + 
  annotate("rect", xmin = 181*24, ymin=-Inf, xmax=365*24, ymax=Inf, alpha=0.1, fill = "red") +
  annotate("text", x = ((365-181)/2+181)*24, y = Inf, label = "Phase III", vjust = 1, size=phase_txt_size) +
  geom_hline(aes(yintercept = upper_limit), subset(threshold_levels, variable == select_var & Tank == select_tank)) +
  geom_hline(aes(yintercept = lower_limit), subset(threshold_levels, variable == select_var & Tank == select_tank)) + theme_bw() + 
  theme(axis.text=element_text(size=12),
        axis.title=element_text(size=14,face="bold"),
        axis.line = element_line(colour = "black"),
        panel.grid.minor = element_blank(),
        panel.background = element_blank(), 
        legend.title = element_blank(),
        panel.border = element_blank()
        )

plot_threshold1_t2 <- ggplot(subset(all_data_smooth_daily2, variable == "NH4_efficiency" & Tank == select_tank), aes(x=delta_hours, y=newMean)) +
  geom_point(alpha=0.1) + 
  geom_smooth() +
  scale_x_continuous(labels=function(x)round(x/24, 0), breaks = seq(-150*24, 365*24, 25*24), limits = c(-150*24, 365*24)) +
  scale_y_continuous(breaks = seq(75, 100, 5), limits = c(75, 100)) +
  xlab("Day") +
  ylab(paste0("NH4 removal eff. (%)")) + 
  annotate("rect", xmin = 0, ymin=-Inf, xmax=58*24, ymax=Inf, alpha=0.1) +
  annotate("text", x = (58/2)*24, y = Inf, label = "Phase I", vjust = 1, size=phase_txt_size) +
  annotate("rect", xmin = 58*24, ymin=-Inf, xmax=(58+31)*24, ymax=Inf, alpha=0.1, fill = "blue") +
  annotate("text", x = (58+15)*24, y = Inf, label = "Phase IIa", vjust = 1, size=phase_txt_size) + 
  annotate("rect", xmin = 89*24, ymin=-Inf, xmax=181*24, ymax=Inf, alpha=0.1, fill = "skyblue") +
  annotate("text", x = ((181-89)/2+89)*24, y = Inf, label = "Phase IIb", vjust = 1, size=phase_txt_size) + 
  annotate("rect", xmin = 181*24, ymin=-Inf, xmax=365*24, ymax=Inf, alpha=0.1, fill = "red") +
  annotate("text", x = ((365-181)/2+181)*24, y = Inf, label = "Phase III", vjust = 1, size=phase_txt_size) +
  geom_hline(aes(yintercept = upper_limit), subset(threshold_levels, variable == "NH4_efficiency" & Tank == select_tank)) +
  geom_hline(aes(yintercept = lower_limit), subset(threshold_levels, variable == "NH4_efficiency" & Tank == select_tank)) + theme_bw() + 
  theme(axis.text=element_text(size=12),
        axis.title=element_text(size=14,face="bold"),
        axis.line = element_line(colour = "black"),
        panel.grid.minor = element_blank(),
        panel.background = element_blank(), 
        legend.title = element_blank(),
        panel.border = element_blank()
        )


plot_nitrifiers_tank2_new <- ggplot(tank2_nitrifiers, aes(x=delta_days, y=Abundance, color = Display)) + geom_point() + geom_line(aes(x=delta_days, y=mean_14d, color = Display)) + scale_y_continuous(breaks = seq(0, 24, 2)) + scale_x_continuous(breaks = seq(-150, 365, 25), limits=c(-150,365)) + theme_bw() + 
  theme(axis.text=element_text(size=12),
        axis.title=element_text(size=14,face="bold"),
        axis.line = element_line(colour = "black"),
        panel.grid.minor = element_blank(),
        panel.background = element_blank(), 
        legend.title = element_blank(),
        panel.border = element_blank(),
        legend.key.size = unit(0.05, "cm"),
        legend.text = element_text(size = 10),
        legend.position = c(0.89, 0.74),
        legend.margin=margin(t = 0.1, unit='cm'))   + scale_color_discrete(limits=c("Planctomycetes; Ca_Brocadia", "Proteobacteria; Nitrosomonas", "Nitrospirae; Nitrospira")) + ylab("Read abundance (%)") + xlab("Day") + 
  annotate("rect", xmin = 0, ymin=0, xmax=58, ymax=Inf, alpha=0.1) +
  annotate("text", x = 58/2, y = 25, label = "Phase I", size=phase_txt_size) +
  annotate("rect", xmin = 58, ymin=0, xmax=58+31, ymax=Inf, alpha=0.1, fill = "blue") +
  annotate("text", x = 58+15, y = 25, label = "Phase IIa", size=phase_txt_size) + 
  annotate("rect", xmin = 89, ymin=0, xmax=181, ymax=Inf, alpha=0.1, fill = "skyblue") +
  annotate("text", x = (181-89)/2+89, y = 25, label = "Phase IIb", size=phase_txt_size) + 
  annotate("rect", xmin = 181, ymin=0, xmax=365, ymax=Inf, alpha=0.1, fill = "red") +
  annotate("text", x = (365-181)/2+181, y = 25, label = "Phase III", size=phase_txt_size)



p_figS3 <- cowplot::plot_grid(plot_threshold_t2, plot_threshold1_t2, plot_nitrifiers_tank2_new, brocadia_tank2_plot, nitrosomonas_tank2_plot, ncol = 1, align = "v", axis = "b", labels = c('A', 'B', 'C', 'D', 'E'))
ggsave(filename = paste0("figures/",format(Sys.Date(), "%Y-%m-%d"),"_figureS6_nh4-nitrifiers-alltime-tank2.png"), plot = p_figS3, width = 15, height = 14.5, dpi = 600)
```



##### Overview
Select only relevant parameters
```{r message=FALSE, warning=FALSE}
df_all_select <- all_data_smooth %>% subset(!(variable %in% c("NH4_in", "NH4_out", "N_converted", "NH4_conc_in", "Water_in", "Flow_hydrocyclone", "Flow_feedtank", "Centrate_in", "NO3_NH4_percent", "HRT", "NH4_rm.", "NH4_eff.", "NH4")))
```

Tank 1 - Figure 1
```{r fig.height = 10, fig.width = 15, fig.align='center', message=FALSE, warning=FALSE}
# Plot
hline.data <-data.frame(thresholds = c(125, 100, 20), variable = c("NH4", "NO3", "NO2"))

phase_text <- data.frame(
  delta_hours = c((58/2)*24, (58+15)*24, 131*24, ((365-181)/2+181)*24), 
  mean = 0.95, 
  lab = c("Phase I", "Phase IIa", "Phase IIb", "Phase III"),
                       variable_order = factor("NLR",levels = c("NLR", "NRR", "NO2", "NO3", "O2", "SS", "Temp", "pH", "AirFlow")))


# line.text <- data.frame(timebucket = c(as.POSIXct("2020-02-17"), as.POSIXct("2020-05-04"), as.POSIXct("2020-06-29"), as.POSIXct("2020-08-03")),
#                         text = c("Bleed-out", "Baseline sampling start", "Increase O2, membrane foul", "Max O2 successful")) %>% mutate(delta_hours = difftime(timebucket, start_sampling_date, units = "hours"))
# line.text$text <- factor(line.text$text, levels = c("Bleed-out", "Baseline sampling start", "Increase O2, membrane foul", "Max O2 successful"))


df_all_select2 <- df_all_select %>% subset(., !(variable == "Temp" & mean < 25) & !(variable == "pH" & mean < 4) & !(variable == "SS" & mean < 100) & !(variable == "NO3" & mean < 0.01) & mean > 0)
# df_all_select2$variable <- recode_factor(df_all_select2$variable, NH4_remove = "NH4_rm.", NH4_efficiency = "NH4_eff.")
df_all_select2$variable_order = factor(df_all_select2$variable, levels=c("NLR", "NRR", "NO2", "NO3", "O2", "SS", "Temp", "pH", "AirFlow"))
# Solution to difficult legends, mixing points and lines https://stackoverflow.com/questions/49015167/difficulty-getting-a-mixed-line-a-and-point-legend-that-specifies-colour-and-sha

library(facetscales)
scales_y <- list(
  #`NH4_rm.` = scale_y_continuous(limits = c(0, 12), breaks = seq(0, 12, 3)),
  #`NH4_eff.` = scale_y_continuous(limits = c(70, 100), breaks = seq(75, 100, 5)),
  #`NO3/NH4` = scale_y_continuous(limits = c(0, 200), breaks = seq(0, 200, 40)),
  #`NH4` = scale_y_continuous(limits = c(0, 225), breaks = seq(0, 200, 50)),
  `NO2` = scale_y_continuous(limits = c(0, 30), breaks = seq(0, 30, 10)),
  `NO3` = scale_y_continuous(limits = c(0, 250), breaks = seq(0, 250, 50)),
  `O2` = scale_y_continuous(limits = c(0, 3), breaks = seq(0, 3, 0.5)),
  `SS` = scale_y_continuous(limits = c(0, 10000), breaks = seq(0, 10000, 2500)),
  `Temp` = scale_y_continuous(limits = c(26, 34), breaks = seq(26, 34, 2)),
  `pH` = scale_y_continuous(limits = c(5.5, 7.5), breaks = seq(5.5, 7.5, 0.5)),
  `AirFlow` = scale_y_continuous(limits = c(100, 600), breaks = seq(100, 600, 100)),
  # `HRT` = scale_y_continuous(limits = c(10, 60), breaks = seq(10, 60, 10)),
  `NLR` = scale_y_continuous(limits = c(0.0, 1.0), breaks = seq(0.0, 1.0, 0.2)),
  `NRR` = scale_y_continuous(limits = c(0.0, 1.0), breaks = seq(0.0, 1.0, 0.2))
)

  p1_overview1 <- 
  ggplot(subset(df_all_select2, Tank == "1" & datatype == "sensor" & variable %in% c("NO2", "NO3", "O2", "Temp", "pH", "SS", "AirFlow")), aes(x = as.numeric(delta_hours), y = mean)) + 
  geom_point(alpha=0.6, aes(shape="Sensor"), color = "black") + 
  geom_smooth(data = subset(df_all_select2, variable %in% c("AirFlow", "NLR", "NRR") & Tank == "1")) +
  #facet_grid(vars(variable), scales = "free") +
  facet_grid_sc(rows = vars(variable_order), scales = list(y=scales_y)) +
  #geom_hline(aes(yintercept = thresholds), hline.data) +
  # geom_vline(aes(xintercept = as.numeric(delta_hours), color = as.factor(text)), data = line.text) +
  theme_bw() +
  theme(axis.text=element_text(size=12),
        axis.title=element_text(size=14,face="bold"),
        legend.title = element_blank(),
        legend.position = "bottom",
        legend.text = element_text(size = 14),
        plot.title = element_text(size = 16),
        strip.text.y = element_text(size = 14, colour = "black")) +
  scale_x_continuous(labels=function(x)round(x/24, 0), breaks = seq(-150*24, 365*24, 25*24))

p1_overview <- p1_overview1 + geom_point(mapping = aes(x=delta_hours, y=mean, shape="Lab"), color = "red", data = subset(df_all_select2, Tank == 1 & datatype == "lab" & variable %in% c("NO2", "NO3", "O2", "Temp", "pH", "SS")), inherit.aes = FALSE) + xlab("Day") + ylab("Hourly mean value") +
  scale_shape_manual(
    values=c(16, 16),
    guide=guide_legend(
      title="Legend: Points",
      override.aes=list(
        colour=c("red", "black"),
        size=c(2, 1.5)
      )
    )
  ) +
  annotate("rect", xmin = 0, ymin=-Inf, xmax=58*24, ymax=Inf, alpha=0.1) +
  #annotate("text", x = (58/2)*24, y = Inf, label = "Phase I", vjust=1) +
  annotate("rect", xmin = 58*24, ymin=-Inf, xmax=(58+31)*24, ymax=Inf, alpha=0.1, fill = "blue") +
  #annotate("text", x = (58+15)*24, y = Inf, label = "Phase IIa", vjust=1) + 
  annotate("rect", xmin = 89*24, ymin=-Inf, xmax=181*24, ymax=Inf, alpha=0.1, fill = "skyblue") +
  #annotate("text", x = ((181-89)/2+89)*24, y = Inf, label = "Phase IIb", vjust=1) + 
  annotate("rect", xmin = 181*24, ymin=-Inf, xmax=365*24, ymax=Inf, alpha=0.1, fill = "red") +
  geom_text(data = phase_text, aes(x=delta_hours, y=mean, label = lab), inherit.aes = FALSE)

ggsave(filename = paste0("figures/",format(Sys.Date(), "%Y-%m-%d"),"_sensor-fullperiod-overview-tank1.png"), plot = p1_overview, width = 15, height = 11, dpi = 300)
```

Tank 2 - Figure S1
```{r fig.height = 10, fig.width = 15, fig.align='center', message=FALSE, warning=FALSE}
# line.text_tank2 <- data.frame(timebucket = c(as.POSIXct("2020-02-17"), as.POSIXct("2020-05-04")),
#                         text = c("Bleed-out", "Baseline sampling start")) %>% mutate(delta_hours = difftime(timebucket, start_sampling_date, units = "hours"))
# line.text_tank2$text <- factor(line.text_tank2$text, levels = c("Bleed-out", "Baseline sampling start"))
phase_text <- data.frame(
  delta_hours = c((58/2)*24, (58+15)*24, 131*24, ((365-181)/2+181)*24), 
  mean = 0.95, 
  lab = c("Phase I", "Phase IIa", "Phase IIb", "Phase III"),
                       variable_order = factor("NLR",levels = c("NLR", "NRR", "NO2", "NO3", "O2", "SS", "Temp", "pH", "AirFlow")))
  
# Plot
p2_overview1 <- 
  ggplot(subset(df_all_select2, Tank == "2" & datatype == "sensor" & variable %in% c("NO2", "NO3", "O2", "Temp", "pH", "SS", "AirFlow")), aes(x = as.numeric(delta_hours), y = mean)) + 
  geom_point(alpha=0.6, aes(shape="Sensor"), color = "black") + 
  geom_smooth(data = subset(df_all_select2, variable %in% c("AirFlow", "NLR", "NRR") & Tank == "2")) +
  #facet_grid(vars(variable), scales = "free") +
  facet_grid_sc(rows = vars(variable_order), scales = list(y=scales_y)) +
  #geom_hline(aes(yintercept = thresholds), hline.data) +
  #geom_vline(aes(xintercept = as.numeric(delta_hours), color = as.factor(text)), data = line.text_tank2) +
  theme_bw() +
  theme(axis.text=element_text(size=12),
        axis.title=element_text(size=14,face="bold"),
        legend.title = element_blank(),
        legend.text = element_text(size = 14),
        legend.position = "bottom",
        plot.title = element_text(size = 16),
        strip.text.y = element_text(size = 14, colour = "black")) +
  scale_x_continuous(labels=function(x)round(x/24, 0), breaks = seq(-150*24, 225*24, 25*24))

p2_overview <- p2_overview1 + geom_point(mapping = aes(x=delta_hours, y=mean, shape="Lab"), color = "red", data = subset(df_all_select2, Tank == "2" & datatype == "lab" & variable %in% c("NO2", "NO3", "O2", "Temp", "pH", "SS")), inherit.aes = FALSE) + xlab("Day") + ylab("Hourly mean value") +
  scale_shape_manual(
    values=c(16, 16),
    guide=guide_legend(
      title="Legend: Points",
      override.aes=list(
        colour=c("red", "black"),
        size=c(2, 1.5)
      )
    )
  ) +
  annotate("rect", xmin = 0, ymin=-Inf, xmax=58*24, ymax=Inf, alpha=0.1) +
  #annotate("text", x = (58/2)*24, y = Inf, label = "Phase I", vjust=1) +
  annotate("rect", xmin = 58*24, ymin=-Inf, xmax=(58+31)*24, ymax=Inf, alpha=0.1, fill = "blue") +
  #annotate("text", x = (58+15)*24, y = Inf, label = "Phase IIa", vjust=1) + 
  annotate("rect", xmin = 89*24, ymin=-Inf, xmax=181*24, ymax=Inf, alpha=0.1, fill = "skyblue") +
  #annotate("text", x = ((181-89)/2+89)*24, y = Inf, label = "Phase IIb", vjust=1) + 
  annotate("rect", xmin = 181*24, ymin=-Inf, xmax=365*24, ymax=Inf, alpha=0.1, fill = "red") +
  geom_text(data = phase_text, aes(x=delta_hours, y=mean, label = lab), inherit.aes = FALSE)

ggsave(filename = paste0("figures/",format(Sys.Date(), "%Y-%m-%d"),"_sensor-fullperiod-overview-tank2.png"), plot = p2_overview, width = 15, height = 11, dpi = 300)
```


##### N2O production
```{r}
ggplot(subset(all_data_smooth, variable == "N2O"), aes(x=delta_hours, y=mean)) + geom_point(alpha=0.1) + 
  geom_smooth() + 
  facet_grid(vars(Tank), scales = "free") + 
  scale_x_continuous(labels=function(x)round(x/24, 0), breaks = seq(-150*24, 365*24, 25*24)) +
  xlab("Days") + ylab("Mean N2O concentration (mg/l)") + theme_bw() + scale_y_continuous(limits = c(0, 5), breaks = seq(0, 5, 0.5)) +
  annotate("rect", xmin = 0, ymin=0, xmax=58*24, ymax=Inf, alpha=0.1) +
  annotate("text", x = (58/2)*24, y = 5, label = "Phase I") +
  annotate("rect", xmin = 58*24, ymin=0, xmax=(58+31)*24, ymax=Inf, alpha=0.1, fill = "blue") +
  annotate("text", x = (58+15)*24, y = 5, label = "Phase IIa") + 
  annotate("rect", xmin = 89*24, ymin=0, xmax=181*24, ymax=Inf, alpha=0.1, fill = "skyblue") +
  annotate("text", x = ((181-89)/2+89)*24, y = 5, label = "Phase IIb") + 
  annotate("rect", xmin = 181*24, ymin=0, xmax=365*24, ymax=Inf, alpha=0.1, fill = "red") +
  annotate("text", x = ((365-181)/2+181)*24, y = 5, label = "Phase III")
```


##### NH4 removal
```{r fig.height = 10, fig.width = 15, fig.align='center', message=FALSE, warning=FALSE}
#nh4_removal <- subset(df_all_select2, variable == "NH4_remove")
#all_data_smooth

# NH4 removal in kg/h
ggplot(subset(all_data_smooth, variable == "NH4_remove"), aes(x=delta_hours, y=mean)) + geom_point(alpha=0.1) + 
  geom_smooth() + 
  facet_grid(vars(Tank), scales = "free") + 
  scale_x_continuous(labels=function(x)round(x/24, 0), breaks = seq(-150*24, 225*24, 25*24)) +
  xlab("Days") + ylab("Mean NH4 removal (kg/h)") + theme_bw() + scale_y_continuous(limits = c(0, 12), breaks = seq(0, 12, 1)) +
  annotate("rect", xmin = 0, ymin=0, xmax=58*24, ymax=12, alpha=0.1) +
  annotate("text", x = (58/2)*24, y = 11.6, label = "Phase I") +
  annotate("rect", xmin = 58*24, ymin=0, xmax=(58+31)*24, ymax=12, alpha=0.1, fill = "blue") +
  annotate("text", x = (58+15)*24, y = 11.6, label = "Phase IIa") + 
  annotate("rect", xmin = 89*24, ymin=0, xmax=181*24, ymax=12, alpha=0.1, fill = "skyblue") +
  annotate("text", x = ((181-89)/2+89)*24, y = 11.6, label = "Phase IIb") + 
  annotate("rect", xmin = 181*24, ymin=0, xmax=230*24, ymax=12, alpha=0.1, fill = "red") +
  annotate("text", x = ((230-181)/2+181)*24, y = 11.6, label = "Phase III")

# NH4 removal in % per day
nh4_removal_daily <- all_data_smooth %>% mutate(day = format(timebucket, format = "%Y-%m-%d"), value=mean) %>% group_by(day, Tank, variable) %>% summarise(mean = mean(value), sd = sd(value)) %>% subset(variable %in% c("NH4_in", "NH4_out")) %>% 
  dcast(., day+Tank~variable, value.var = "mean") %>% 
  mutate(NH4_in = NH4_in*24, NH4_out = NH4_out*24, NH4_percent = ((NH4_in-NH4_out)/NH4_in)*100, delta_days = as.numeric(difftime(day, start_sampling_date, units = "days")))

ggplot(nh4_removal_daily, aes(x=delta_days, y=NH4_percent)) + geom_point(alpha=0.1) + geom_smooth() + facet_grid(vars(Tank), scales = "free") + 
  scale_x_continuous(breaks = seq(-150, 225, 25)) +
  xlab("Days") + ylab("Mean NH4 removal (%)") + theme_bw() + scale_y_continuous(limits = c(70, 100), breaks = seq(70, 100, 2)) +
  annotate("rect", xmin = 0, ymin=70, xmax=58, ymax=100, alpha=0.1) +
  annotate("text", x = (58/2), y = 99, label = "Phase I") +
  annotate("rect", xmin = 58, ymin=70, xmax=(58+31), ymax=100, alpha=0.1, fill = "blue") +
  annotate("text", x = (58+15), y = 99, label = "Phase IIa") + 
  annotate("rect", xmin = 89, ymin=70, xmax=181, ymax=100, alpha=0.1, fill = "skyblue") +
  annotate("text", x = ((181-89)/2+89), y = 99, label = "Phase IIb") + 
  annotate("rect", xmin = 181, ymin=70, xmax=230, ymax=100, alpha=0.1, fill = "red") +
  annotate("text", x = ((230-181)/2+181), y = 99, label = "Phase III")

# N2O
ggplot(subset(all_data_smooth, variable == "N2O"), aes(x=delta_hours, y=mean)) + geom_point(alpha=0.1) + geom_smooth() + facet_grid(vars(Tank), scales = "free") + 
  #scale_x_continuous(breaks = seq(-150, 225, 25)) +
  scale_x_continuous(labels=function(x)round(x/24, 0), breaks = seq(100*24, 230*24, 10*24), limits=c(100*24,230*24)) +
  geom_vline(xintercept = 130*24) +
  xlab("Days") + ylab("Mean N2O in tank (mg/L)") + theme_bw() #+ 
  scale_y_continuous(limits = c(250, 1250), breaks = seq(250, 1250, 50)) +
  annotate("rect", xmin = 0, ymin=250, xmax=58*24, ymax=1250, alpha=0.1) +
  annotate("text", x = (58/2)*24, y = 1200, label = "Phase I") +
  annotate("rect", xmin = 58*24, ymin=250, xmax=(58+31)*24, ymax=1250, alpha=0.1, fill = "blue") +
  annotate("text", x = (58+15)*24, y = 1200, label = "Phase IIa") + 
  annotate("rect", xmin = 89*24, ymin=250, xmax=181*24, ymax=1250, alpha=0.1, fill = "skyblue") +
  annotate("text", x = ((181-89)/2+89)*24, y = 1200, label = "Phase IIb") + 
  annotate("rect", xmin = 181*24, ymin=250, xmax=230*24, ymax=1250, alpha=0.1, fill = "red") +
  annotate("text", x = ((230-181)/2+181)*24, y = 1200, label = "Phase III")

# N removal
N_converted <- all_data_smooth %>% subset(variable == "N_converted")

ggplot(N_converted, aes(x=delta_hours, y=mean)) + geom_point(alpha=0.1) + geom_smooth() + facet_grid(vars(Tank), scales = "free") + 
  #scale_x_continuous(breaks = seq(-150, 225, 25)) +
  scale_x_continuous(labels=function(x)round(x/24, 0), breaks = seq(-150*24, 225*24, 25*24)) +
  geom_vline(xintercept = 160*24) +
  xlab("Days") + ylab("Mean N converted to gas (mg/L)") + theme_bw() + 
  scale_y_continuous(limits = c(250, 1250), breaks = seq(250, 1250, 50)) +
  #annotate("rect", xmin = 105*24, ymin=250, xmax=160*24, ymax=1250, alpha=0.3, fill="pink") +
  #annotate("text", x = 130*24, y = 1000, label = "Start up N2O - unstable") +
  annotate("rect", xmin = 0, ymin=250, xmax=58*24, ymax=1250, alpha=0.1) +
  annotate("text", x = (58/2)*24, y = 1200, label = "Phase I") +
  annotate("rect", xmin = 58*24, ymin=250, xmax=(58+31)*24, ymax=1250, alpha=0.1, fill = "blue") +
  annotate("text", x = (58+15)*24, y = 1200, label = "Phase IIa") + 
  annotate("rect", xmin = 89*24, ymin=250, xmax=181*24, ymax=1250, alpha=0.1, fill = "skyblue") +
  annotate("text", x = ((181-89)/2+89)*24, y = 1200, label = "Phase IIb") + 
  annotate("rect", xmin = 181*24, ymin=250, xmax=230*24, ymax=1250, alpha=0.1, fill = "red") +
  annotate("text", x = ((230-181)/2+181)*24, y = 1200, label = "Phase III")
```

##### NLR - Nitrogen loading rate
```{r fig.height = 10, fig.width = 15, fig.align='center', message=FALSE, warning=FALSE}
# Nitrogen loading rate in kg-NH4/m3/d
ggplot(subset(all_data_smooth, variable == "NLR"), aes(x=delta_hours, y=newMean)) + geom_point(alpha=0.1) + 
  geom_smooth() + 
  facet_grid(vars(Tank), scales = "free") + 
  scale_x_continuous(labels=function(x)round(x/24, 0), breaks = seq(-150*24, 365*24, 25*24)) +
  xlab("Days") + ylab("Nitrogen loading rate (kg NH4/m3/d)") + theme_bw() + scale_y_continuous(limits = c(0, 1.2), breaks = seq(0, 1.2, 0.1)) +
  annotate("rect", xmin = 0, ymin=0, xmax=58*24, ymax=1.2, alpha=0.1) +
  annotate("text", x = (58/2)*24, y = 1.16, label = "Phase I") +
  annotate("rect", xmin = 58*24, ymin=0, xmax=(58+31)*24, ymax=1.2, alpha=0.1, fill = "blue") +
  annotate("text", x = (58+15)*24, y = 1.16, label = "Phase IIa") + 
  annotate("rect", xmin = 89*24, ymin=0, xmax=181*24, ymax=1.2, alpha=0.1, fill = "skyblue") +
  annotate("text", x = ((181-89)/2+89)*24, y = 1.16, label = "Phase IIb") + 
  annotate("rect", xmin = 181*24, ymin=0, xmax=Inf, ymax=1.2, alpha=0.1, fill = "red") +
  annotate("text", x = ((365-181)/2+181)*24, y = 1.16, label = "Phase III")
```


##### AOR - Ammonia oxidation rate
```{r fig.height = 10, fig.width = 15, fig.align='center', message=FALSE, warning=FALSE}
# Ammonia oxidation rate in kg-NH4/m3/d
aor12 <- ggplot(subset(all_data_smooth, variable == "AOR"), aes(x=delta_hours, y=newMean)) + geom_point(alpha=0.1) + 
  geom_smooth() + 
  facet_wrap(~ Tank, scales = "free") + 
  scale_x_continuous(labels=function(x)round(x/24, 0), breaks = seq(-150*24, 365*24, 25*24)) +
  xlab("Days") + ylab("Ammonia oxidation rate (kg NH4/m3/d)") + 
  theme_bw() + 
  scale_y_continuous(limits = c(0, 1), breaks = seq(0, 1, 0.1)) +
  annotate("rect", xmin = 0, ymin=0, xmax=58*24, ymax=Inf, alpha=0.1) +
  annotate("text", x = (58/2)*24, y = 0.98, label = "Phase I") +
  annotate("rect", xmin = 58*24, ymin=0, xmax=(58+31)*24, ymax=Inf, alpha=0.1, fill = "blue") +
  annotate("text", x = (58+15)*24, y = 0.98, label = "Phase IIa") + 
  annotate("rect", xmin = 89*24, ymin=0, xmax=181*24, ymax=Inf, alpha=0.1, fill = "skyblue") +
  annotate("text", x = ((181-89)/2+89)*24, y = 0.98, label = "Phase IIb") + 
  annotate("rect", xmin = 181*24, ymin=0, xmax=Inf, ymax=Inf, alpha=0.1, fill = "red") +
  annotate("text", x = ((365-181)/2+181)*24, y = 0.98, label = "Phase III")

# Nitrogen oxidation rate in kg-NH4/m3/d
nor12 <- ggplot(subset(all_data_smooth, variable == "NOR"), aes(x=delta_hours, y=newMean)) + geom_point(alpha=0.1) + 
  geom_smooth() + 
  facet_wrap(~ Tank, scales = "free") + 
  scale_x_continuous(labels=function(x)round(x/24, 0), breaks = seq(-150*24, 365*24, 25*24)) +
  xlab("Days") + ylab("Nitrite oxidation rate (kg NO2-/m3/d)") + 
  theme_bw() + 
  scale_y_continuous(limits = c(0, 1), breaks = seq(0, 1, 0.1)) +
  annotate("rect", xmin = 0, ymin=0, xmax=58*24, ymax=Inf, alpha=0.1) +
  annotate("text", x = (58/2)*24, y = 0.98, label = "Phase I") +
  annotate("rect", xmin = 58*24, ymin=0, xmax=(58+31)*24, ymax=Inf, alpha=0.1, fill = "blue") +
  annotate("text", x = (58+15)*24, y = 0.98, label = "Phase IIa") + 
  annotate("rect", xmin = 89*24, ymin=0, xmax=181*24, ymax=Inf, alpha=0.1, fill = "skyblue") +
  annotate("text", x = ((181-89)/2+89)*24, y = 0.98, label = "Phase IIb") + 
  annotate("rect", xmin = 181*24, ymin=0, xmax=Inf, ymax=Inf, alpha=0.1, fill = "red") +
  annotate("text", x = ((365-181)/2+181)*24, y = 0.98, label = "Phase III")

# Nitrogen removal rate in kg-NH4/m3/d
nrr12 <- ggplot(subset(all_data_smooth, variable == "NRR"), aes(x=delta_hours, y=newMean)) + geom_point(alpha=0.1) + 
  geom_smooth() + 
  facet_wrap(~ Tank, scales = "free") + 
  scale_x_continuous(labels=function(x)round(x/24, 0), breaks = seq(-150*24, 365*24, 25*24)) +
  xlab("Days") + ylab("Nitrogen removal rate (kg NH4/m3/d)") + 
  theme_bw() + 
  scale_y_continuous(limits = c(0, 1), breaks = seq(0, 1, 0.1)) +
  annotate("rect", xmin = 0, ymin=0, xmax=58*24, ymax=Inf, alpha=0.1) +
  annotate("text", x = (58/2)*24, y = 0.98, label = "Phase I") +
  annotate("rect", xmin = 58*24, ymin=0, xmax=(58+31)*24, ymax=Inf, alpha=0.1, fill = "blue") +
  annotate("text", x = (58+15)*24, y = 0.98, label = "Phase IIa") + 
  annotate("rect", xmin = 89*24, ymin=0, xmax=181*24, ymax=Inf, alpha=0.1, fill = "skyblue") +
  annotate("text", x = ((181-89)/2+89)*24, y = 0.98, label = "Phase IIb") + 
  annotate("rect", xmin = 181*24, ymin=0, xmax=Inf, ymax=Inf, alpha=0.1, fill = "red") +
  annotate("text", x = ((365-181)/2+181)*24, y = 0.98, label = "Phase III")


grid.arrange(aor12, nor12, nrr12, nrow=3)
```

##### Airflow
```{r fig.height = 10, fig.width = 15, fig.align='center', message=FALSE, warning=FALSE}
airflow <- all_data_smooth %>% subset(variable == "AirFlow") %>% mutate(day = format(timebucket, format = "%Y-%m-%d"), value=mean) %>% group_by(day, Tank, variable) %>% summarise(mean = mean(value), sd = sd(value)) %>% mutate(delta_days = as.numeric(difftime(day, start_sampling_date, units = "days")))

ggplot(airflow, aes(x=delta_days, y=mean)) + geom_point(alpha=0.1) + geom_smooth() + facet_grid(vars(Tank), scales = "free") + 
  scale_x_continuous(breaks = seq(-150, 225, 25)) +
  xlab("Days") + ylab("Airflow (m3/h)") + theme_bw() + 
  scale_y_continuous(limits = c(100, 450), breaks = seq(100, 450, 25)) +
  annotate("rect", xmin = 0, ymin=100, xmax=58, ymax=450, alpha=0.1) +
  annotate("text", x = (58/2), y = 440, label = "Phase I") +
  annotate("rect", xmin = 58, ymin=100, xmax=(58+31), ymax=450, alpha=0.1, fill = "blue") +
  annotate("text", x = (58+15), y = 440, label = "Phase IIa") + 
  annotate("rect", xmin = 89, ymin=100, xmax=181, ymax=450, alpha=0.1, fill = "skyblue") +
  annotate("text", x = ((181-89)/2+89), y = 440, label = "Phase IIb") + 
  annotate("rect", xmin = 181, ymin=100, xmax=230, ymax=450, alpha=0.1, fill = "red") +
  annotate("text", x = ((230-181)/2+181), y = 440, label = "Phase III")
```

### Since start august
```{r fig.height = 10, fig.width = 15, fig.align='center', message=FALSE, warning=FALSE}
# Since start august
hline.data <-data.frame(thresholds = c(125, 100, 20), variable = c("NH4", "NO3", "NO2"))
color_vector <- c("3 day MA"="#f04546",
          "5 day MA"="#3591d1",
          "Thresholds" = "black")

august_now <- df_all_select %>% subset(timebucket >= "2020-05-01" & timebucket <"2020-12-01")

# Tank 1
tank1_aug <- ggplot(data = subset(august_now, Tank == 1 & datatype == "sensor")) + 
  geom_point(aes(x=timebucket, y=mean), alpha=0.5) + 
  #geom_line(aes(x=timebucket, y=mean_03d, group=1, color = "3 day MA")) + 
  #geom_line(aes(x=timebucket, y=mean_05d, group=1, color = "5 day MA")) + 
  geom_hline(aes(yintercept = thresholds, color = "Thresholds"), hline.data, linetype = "dashed") +
  facet_grid(vars(variable), scales = "free") +
  theme_bw() +
  theme(legend.title = element_blank(),
        legend.position = "bottom",
        axis.text = element_text(size = 12),
        axis.title = element_text(size = 14),
        axis.text.x = element_text(angle=45, hjust=1),
        legend.text = element_text(size = 14),
        plot.title = element_text(size = 16),
        strip.text.y = element_text(size = 14, colour = "black")) +
  xlab("Date") + ylab("Hourly mean value") +
  #scale_colour_manual(name="Moving average",values=color_vector) +
  scale_x_datetime(labels = date_format("%b-%d"),
                   date_breaks = ("1 week")) +
  ggtitle("VCS DEMON tank 1, Phase 2 Aug. 2020 - Nov. 2020 online sensor data")

tank1_aug + geom_point(mapping = aes(x=timebucket, y=mean), color = "red", data = subset(august_now, Tank == 1 & datatype == "lab"), inherit.aes = FALSE) # Add lab data for tank


## Tank 2 ##
tank2_aug <- ggplot(subset(august_now, Tank == 2 & datatype == "sensor")) + 
  geom_point(aes(x=timebucket, y=mean), alpha=0.5) + 
  geom_line(aes(x=timebucket, y=mean_03d, group=1, color = "3 day MA")) + 
  geom_line(aes(x=timebucket, y=mean_05d, group=1, color = "5 day MA")) + 
  geom_hline(aes(yintercept = thresholds, color = "Thresholds"), hline.data, linetype = "dashed") +
  facet_grid(vars(variable), scales = "free") +
  theme_bw() +
  theme(legend.title = element_blank(),
        legend.position = "bottom",
        axis.text = element_text(size = 12),
         axis.text.x = element_text(angle=45, hjust=1),
        axis.title = element_text(size = 14),
        legend.text = element_text(size = 14),
        plot.title = element_text(size = 16),
        strip.text.y = element_text(size = 14, colour = "orange")) +
  xlab("Date") + ylab("Hourly mean value") +
  scale_colour_manual(name="Moving average",values=color_vector) +
  scale_x_datetime(labels = date_format("%Y-%b-%d"),
                   date_breaks = ("1 week")) +
  ggtitle("VCS DEMON tank 2, Aug. 2020 - Nov. 2020 online sensor data")

tank2_aug + geom_point(mapping = aes(x=timebucket, y=mean), color = "red", data = subset(august_now, Tank == 2 & datatype == "lab"), inherit.aes = FALSE) # Add lab data for tank
```

Overlay points to compare tanks
```{r fig.height = 10, fig.width = 15, fig.align='center', message=FALSE, warning=FALSE}
ggplot(subset(august_now, datatype == "sensor")) + 
  geom_point(aes(x=timebucket, y=mean, color = factor(Tank)), alpha=0.5) + 
  #geom_line(aes(x=timebucket, y=mean_03d, group=1, color = "3 day MA")) + 
  #geom_line(aes(x=timebucket, y=mean_05d, group=1, color = "5 day MA")) + 
  geom_hline(aes(yintercept = thresholds), hline.data, linetype = "dashed") +
  facet_grid(vars(variable), scales = "free") +
  theme_bw() +
  theme(#legend.title = element_blank(),
        legend.position = "bottom",
        axis.text = element_text(size = 12),
        axis.title = element_text(size = 14),
        axis.text.x = element_text(angle=45, hjust=1),
        legend.text = element_text(size = 14),
        legend.title = element_text(size = 16),
        plot.title = element_text(size = 16),
        #legend.key.size = unit(3, "cm"),
        strip.text.y = element_text(size = 14, colour = "black")) +
  xlab("Date") + ylab("Hourly mean value") +
  scale_x_datetime(labels = date_format("%b-%d"),
                   date_breaks = ("1 week")) +
  scale_colour_manual(name="Tank",values= c("#f04546","#3591d1")) +
  ggtitle("VCS DEMON tanks, May 2020 - Nov. 2020 online sensor data")
```